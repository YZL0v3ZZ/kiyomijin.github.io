<?xml version="1.0"?>
<feed xmlns="http://www.w3.org/2005/Atom">
    <id>https://kiyomijin.github.io</id>
    <title>My Violet Eva Garden • Posts by &#34;文件上传漏洞探究&#34; tag</title>
    <link href="https://kiyomijin.github.io" />
    <updated>2022-10-03T09:24:28.000Z</updated>
    <category term="原创" />
    <category term="数据库安全" />
    <category term="SQL注入探究" />
    <category term="文件上传漏洞探究" />
    <category term="CTF小训" />
    <category term="Misc" />
    <entry>
        <id>https://kiyomijin.github.io/2022/10/03/%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%BC%8F%E6%B4%9E%E6%8E%A2%E7%A9%B6/%E5%90%8E%E7%BC%80%E5%8A%A0%E7%89%B9%E6%AE%8A%E5%AD%97%E7%AC%A6%E7%BB%95%E8%BF%87/</id>
        <title>后缀加特殊字符绕过</title>
        <link rel="alternate" href="https://kiyomijin.github.io/2022/10/03/%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%BC%8F%E6%B4%9E%E6%8E%A2%E7%A9%B6/%E5%90%8E%E7%BC%80%E5%8A%A0%E7%89%B9%E6%AE%8A%E5%AD%97%E7%AC%A6%E7%BB%95%E8%BF%87/"/>
        <content type="html">&lt;h1 id=&#34;后缀加特殊字符绕过&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#后缀加特殊字符绕过&#34;&gt;#&lt;/a&gt; 后缀加特殊字符绕过&lt;/h1&gt;
&lt;p&gt;本次讲解后缀加特殊字符绕过。&lt;/p&gt;
&lt;h2 id=&#34;后缀加点绕过&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#后缀加点绕过&#34;&gt;#&lt;/a&gt; 后缀加点绕过&lt;/h2&gt;
&lt;p&gt;常规看源码&lt;/p&gt;
&lt;figure class=&#34;highlight php&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;variable&#34;&gt;$is_upload&lt;/span&gt; = &lt;span class=&#34;literal&#34;&gt;false&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;variable&#34;&gt;$msg&lt;/span&gt; = &lt;span class=&#34;literal&#34;&gt;null&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;keyword&#34;&gt;if&lt;/span&gt; (&lt;span class=&#34;keyword&#34;&gt;isset&lt;/span&gt;(&lt;span class=&#34;variable&#34;&gt;$_POST&lt;/span&gt;[&lt;span class=&#34;string&#34;&gt;&amp;#x27;submit&amp;#x27;&lt;/span&gt;])) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;keyword&#34;&gt;if&lt;/span&gt; (&lt;span class=&#34;title function_ invoke__&#34;&gt;file_exists&lt;/span&gt;(UPLOAD_PATH)) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &lt;span class=&#34;variable&#34;&gt;$deny_ext&lt;/span&gt; = &lt;span class=&#34;keyword&#34;&gt;array&lt;/span&gt;(&lt;span class=&#34;string&#34;&gt;&amp;quot;.php&amp;quot;&lt;/span&gt;,&lt;span class=&#34;string&#34;&gt;&amp;quot;.php5&amp;quot;&lt;/span&gt;,&lt;span class=&#34;string&#34;&gt;&amp;quot;.php4&amp;quot;&lt;/span&gt;,&lt;span class=&#34;string&#34;&gt;&amp;quot;.php3&amp;quot;&lt;/span&gt;,&lt;span class=&#34;string&#34;&gt;&amp;quot;.php2&amp;quot;&lt;/span&gt;,&lt;span class=&#34;string&#34;&gt;&amp;quot;.html&amp;quot;&lt;/span&gt;,&lt;span class=&#34;string&#34;&gt;&amp;quot;.htm&amp;quot;&lt;/span&gt;,&lt;span class=&#34;string&#34;&gt;&amp;quot;.phtml&amp;quot;&lt;/span&gt;,&lt;span class=&#34;string&#34;&gt;&amp;quot;.pht&amp;quot;&lt;/span&gt;,&lt;span class=&#34;string&#34;&gt;&amp;quot;.pHp&amp;quot;&lt;/span&gt;,&lt;span class=&#34;string&#34;&gt;&amp;quot;.pHp5&amp;quot;&lt;/span&gt;,&lt;span class=&#34;string&#34;&gt;&amp;quot;.pHp4&amp;quot;&lt;/span&gt;,&lt;span class=&#34;string&#34;&gt;&amp;quot;.pHp3&amp;quot;&lt;/span&gt;,&lt;span class=&#34;string&#34;&gt;&amp;quot;.pHp2&amp;quot;&lt;/span&gt;,&lt;span class=&#34;string&#34;&gt;&amp;quot;.Html&amp;quot;&lt;/span&gt;,&lt;span class=&#34;string&#34;&gt;&amp;quot;.Htm&amp;quot;&lt;/span&gt;,&lt;span class=&#34;string&#34;&gt;&amp;quot;.pHtml&amp;quot;&lt;/span&gt;,&lt;span class=&#34;string&#34;&gt;&amp;quot;.jsp&amp;quot;&lt;/span&gt;,&lt;span class=&#34;string&#34;&gt;&amp;quot;.jspa&amp;quot;&lt;/span&gt;,&lt;span class=&#34;string&#34;&gt;&amp;quot;.jspx&amp;quot;&lt;/span&gt;,&lt;span class=&#34;string&#34;&gt;&amp;quot;.jsw&amp;quot;&lt;/span&gt;,&lt;span class=&#34;string&#34;&gt;&amp;quot;.jsv&amp;quot;&lt;/span&gt;,&lt;span class=&#34;string&#34;&gt;&amp;quot;.jspf&amp;quot;&lt;/span&gt;,&lt;span class=&#34;string&#34;&gt;&amp;quot;.jtml&amp;quot;&lt;/span&gt;,&lt;span class=&#34;string&#34;&gt;&amp;quot;.jSp&amp;quot;&lt;/span&gt;,&lt;span class=&#34;string&#34;&gt;&amp;quot;.jSpx&amp;quot;&lt;/span&gt;,&lt;span class=&#34;string&#34;&gt;&amp;quot;.jSpa&amp;quot;&lt;/span&gt;,&lt;span class=&#34;string&#34;&gt;&amp;quot;.jSw&amp;quot;&lt;/span&gt;,&lt;span class=&#34;string&#34;&gt;&amp;quot;.jSv&amp;quot;&lt;/span&gt;,&lt;span class=&#34;string&#34;&gt;&amp;quot;.jSpf&amp;quot;&lt;/span&gt;,&lt;span class=&#34;string&#34;&gt;&amp;quot;.jHtml&amp;quot;&lt;/span&gt;,&lt;span class=&#34;string&#34;&gt;&amp;quot;.asp&amp;quot;&lt;/span&gt;,&lt;span class=&#34;string&#34;&gt;&amp;quot;.aspx&amp;quot;&lt;/span&gt;,&lt;span class=&#34;string&#34;&gt;&amp;quot;.asa&amp;quot;&lt;/span&gt;,&lt;span class=&#34;string&#34;&gt;&amp;quot;.asax&amp;quot;&lt;/span&gt;,&lt;span class=&#34;string&#34;&gt;&amp;quot;.ascx&amp;quot;&lt;/span&gt;,&lt;span class=&#34;string&#34;&gt;&amp;quot;.ashx&amp;quot;&lt;/span&gt;,&lt;span class=&#34;string&#34;&gt;&amp;quot;.asmx&amp;quot;&lt;/span&gt;,&lt;span class=&#34;string&#34;&gt;&amp;quot;.cer&amp;quot;&lt;/span&gt;,&lt;span class=&#34;string&#34;&gt;&amp;quot;.aSp&amp;quot;&lt;/span&gt;,&lt;span class=&#34;string&#34;&gt;&amp;quot;.aSpx&amp;quot;&lt;/span&gt;,&lt;span class=&#34;string&#34;&gt;&amp;quot;.aSa&amp;quot;&lt;/span&gt;,&lt;span class=&#34;string&#34;&gt;&amp;quot;.aSax&amp;quot;&lt;/span&gt;,&lt;span class=&#34;string&#34;&gt;&amp;quot;.aScx&amp;quot;&lt;/span&gt;,&lt;span class=&#34;string&#34;&gt;&amp;quot;.aShx&amp;quot;&lt;/span&gt;,&lt;span class=&#34;string&#34;&gt;&amp;quot;.aSmx&amp;quot;&lt;/span&gt;,&lt;span class=&#34;string&#34;&gt;&amp;quot;.cEr&amp;quot;&lt;/span&gt;,&lt;span class=&#34;string&#34;&gt;&amp;quot;.sWf&amp;quot;&lt;/span&gt;,&lt;span class=&#34;string&#34;&gt;&amp;quot;.swf&amp;quot;&lt;/span&gt;,&lt;span class=&#34;string&#34;&gt;&amp;quot;.htaccess&amp;quot;&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &lt;span class=&#34;variable&#34;&gt;$file_name&lt;/span&gt; = &lt;span class=&#34;title function_ invoke__&#34;&gt;trim&lt;/span&gt;(&lt;span class=&#34;variable&#34;&gt;$_FILES&lt;/span&gt;[&lt;span class=&#34;string&#34;&gt;&amp;#x27;upload_file&amp;#x27;&lt;/span&gt;][&lt;span class=&#34;string&#34;&gt;&amp;#x27;name&amp;#x27;&lt;/span&gt;]);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &lt;span class=&#34;variable&#34;&gt;$file_ext&lt;/span&gt; = &lt;span class=&#34;title function_ invoke__&#34;&gt;strrchr&lt;/span&gt;(&lt;span class=&#34;variable&#34;&gt;$file_name&lt;/span&gt;, &lt;span class=&#34;string&#34;&gt;&amp;#x27;.&amp;#x27;&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &lt;span class=&#34;variable&#34;&gt;$file_ext&lt;/span&gt; = &lt;span class=&#34;title function_ invoke__&#34;&gt;strtolower&lt;/span&gt;(&lt;span class=&#34;variable&#34;&gt;$file_ext&lt;/span&gt;); &lt;span class=&#34;comment&#34;&gt;//转换为小写&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &lt;span class=&#34;variable&#34;&gt;$file_ext&lt;/span&gt; = &lt;span class=&#34;title function_ invoke__&#34;&gt;str_ireplace&lt;/span&gt;(&lt;span class=&#34;string&#34;&gt;&amp;#x27;::$DATA&amp;#x27;&lt;/span&gt;, &lt;span class=&#34;string&#34;&gt;&amp;#x27;&amp;#x27;&lt;/span&gt;, &lt;span class=&#34;variable&#34;&gt;$file_ext&lt;/span&gt;);&lt;span class=&#34;comment&#34;&gt;//去除字符串::$DATA&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &lt;span class=&#34;variable&#34;&gt;$file_ext&lt;/span&gt; = &lt;span class=&#34;title function_ invoke__&#34;&gt;trim&lt;/span&gt;(&lt;span class=&#34;variable&#34;&gt;$file_ext&lt;/span&gt;); &lt;span class=&#34;comment&#34;&gt;//首尾去空&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &lt;span class=&#34;keyword&#34;&gt;if&lt;/span&gt; (!&lt;span class=&#34;title function_ invoke__&#34;&gt;in_array&lt;/span&gt;(&lt;span class=&#34;variable&#34;&gt;$file_ext&lt;/span&gt;, &lt;span class=&#34;variable&#34;&gt;$deny_ext&lt;/span&gt;)) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;            &lt;span class=&#34;variable&#34;&gt;$temp_file&lt;/span&gt; = &lt;span class=&#34;variable&#34;&gt;$_FILES&lt;/span&gt;[&lt;span class=&#34;string&#34;&gt;&amp;#x27;upload_file&amp;#x27;&lt;/span&gt;][&lt;span class=&#34;string&#34;&gt;&amp;#x27;tmp_name&amp;#x27;&lt;/span&gt;];&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;            &lt;span class=&#34;variable&#34;&gt;$img_path&lt;/span&gt; = UPLOAD_PATH.&lt;span class=&#34;string&#34;&gt;&amp;#x27;/&amp;#x27;&lt;/span&gt;.&lt;span class=&#34;variable&#34;&gt;$file_name&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;            &lt;span class=&#34;keyword&#34;&gt;if&lt;/span&gt; (&lt;span class=&#34;title function_ invoke__&#34;&gt;move_uploaded_file&lt;/span&gt;(&lt;span class=&#34;variable&#34;&gt;$temp_file&lt;/span&gt;, &lt;span class=&#34;variable&#34;&gt;$img_path&lt;/span&gt;)) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;                &lt;span class=&#34;variable&#34;&gt;$is_upload&lt;/span&gt; = &lt;span class=&#34;literal&#34;&gt;true&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;            &amp;#125; &lt;span class=&#34;keyword&#34;&gt;else&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;                &lt;span class=&#34;variable&#34;&gt;$msg&lt;/span&gt; = &lt;span class=&#34;string&#34;&gt;&amp;#x27;上传出错！&amp;#x27;&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;            &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &amp;#125; &lt;span class=&#34;keyword&#34;&gt;else&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;            &lt;span class=&#34;variable&#34;&gt;$msg&lt;/span&gt; = &lt;span class=&#34;string&#34;&gt;&amp;#x27;此文件类型不允许上传！&amp;#x27;&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &amp;#125; &lt;span class=&#34;keyword&#34;&gt;else&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &lt;span class=&#34;variable&#34;&gt;$msg&lt;/span&gt; = UPLOAD_PATH . &lt;span class=&#34;string&#34;&gt;&amp;#x27;文件夹不存在,请手工创建！&amp;#x27;&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;发现并没对后缀名的最后一个。进行 deldot ()，因此存在后缀加点绕过漏洞。&lt;/p&gt;
&lt;p&gt;抓包，修改上传文件名，加个点：&lt;/p&gt;
&lt;figure class=&#34;highlight php&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;filename=&lt;span class=&#34;string&#34;&gt;&amp;quot;backdoor.php.&amp;quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;&lt;img src=&#34;image-20221003172734314.png&#34; alt=&#34;image-20221003172734314&#34;&gt;&lt;/p&gt;
&lt;p&gt;菜刀连接对应文件即可。&lt;/p&gt;
&lt;h2 id=&#34;后缀加data绕过&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#后缀加data绕过&#34;&gt;#&lt;/a&gt; 后缀加::$DATA 绕过&lt;/h2&gt;
&lt;p&gt;&lt;img src=&#34;image-20221003173227712.png&#34; alt=&#34;image-20221003173227712&#34;&gt;&lt;br&gt;
 抓包，修改文件名：&lt;/p&gt;
&lt;figure class=&#34;highlight php&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;filename=&lt;span class=&#34;string&#34;&gt;&amp;quot;backdoor.php::&lt;span class=&#34;subst&#34;&gt;$DATA&lt;/span&gt;&amp;quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;&lt;img src=&#34;image-20221003174926600.png&#34; alt=&#34;image-20221003174926600&#34;&gt;&lt;/p&gt;
&lt;p&gt;在上传后由于文件流的特性::$DATA 会自动去除，而最终上传的是 php 文件&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;image-20221003175017386.png&#34; alt=&#34;image-20221003175017386&#34;&gt;&lt;/p&gt;
&lt;h2 id=&#34;后缀加点空格点绕过&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#后缀加点空格点绕过&#34;&gt;#&lt;/a&gt; 后缀加点 + 空格 + 点绕过&lt;/h2&gt;
&lt;p&gt;后缀 + &lt;code&gt;. .&lt;/code&gt;  来进行绕过&lt;/p&gt;
&lt;p&gt;来看看源码&lt;/p&gt;
&lt;figure class=&#34;highlight php&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;variable&#34;&gt;$is_upload&lt;/span&gt; = &lt;span class=&#34;literal&#34;&gt;false&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;variable&#34;&gt;$msg&lt;/span&gt; = &lt;span class=&#34;literal&#34;&gt;null&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;keyword&#34;&gt;if&lt;/span&gt; (&lt;span class=&#34;keyword&#34;&gt;isset&lt;/span&gt;(&lt;span class=&#34;variable&#34;&gt;$_POST&lt;/span&gt;[&lt;span class=&#34;string&#34;&gt;&amp;#x27;submit&amp;#x27;&lt;/span&gt;])) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;keyword&#34;&gt;if&lt;/span&gt; (&lt;span class=&#34;title function_ invoke__&#34;&gt;file_exists&lt;/span&gt;(UPLOAD_PATH)) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &lt;span class=&#34;variable&#34;&gt;$deny_ext&lt;/span&gt; = &lt;span class=&#34;keyword&#34;&gt;array&lt;/span&gt;(&lt;span class=&#34;string&#34;&gt;&amp;quot;.php&amp;quot;&lt;/span&gt;,&lt;span class=&#34;string&#34;&gt;&amp;quot;.php5&amp;quot;&lt;/span&gt;,&lt;span class=&#34;string&#34;&gt;&amp;quot;.php4&amp;quot;&lt;/span&gt;,&lt;span class=&#34;string&#34;&gt;&amp;quot;.php3&amp;quot;&lt;/span&gt;,&lt;span class=&#34;string&#34;&gt;&amp;quot;.php2&amp;quot;&lt;/span&gt;,&lt;span class=&#34;string&#34;&gt;&amp;quot;.html&amp;quot;&lt;/span&gt;,&lt;span class=&#34;string&#34;&gt;&amp;quot;.htm&amp;quot;&lt;/span&gt;,&lt;span class=&#34;string&#34;&gt;&amp;quot;.phtml&amp;quot;&lt;/span&gt;,&lt;span class=&#34;string&#34;&gt;&amp;quot;.pht&amp;quot;&lt;/span&gt;,&lt;span class=&#34;string&#34;&gt;&amp;quot;.pHp&amp;quot;&lt;/span&gt;,&lt;span class=&#34;string&#34;&gt;&amp;quot;.pHp5&amp;quot;&lt;/span&gt;,&lt;span class=&#34;string&#34;&gt;&amp;quot;.pHp4&amp;quot;&lt;/span&gt;,&lt;span class=&#34;string&#34;&gt;&amp;quot;.pHp3&amp;quot;&lt;/span&gt;,&lt;span class=&#34;string&#34;&gt;&amp;quot;.pHp2&amp;quot;&lt;/span&gt;,&lt;span class=&#34;string&#34;&gt;&amp;quot;.Html&amp;quot;&lt;/span&gt;,&lt;span class=&#34;string&#34;&gt;&amp;quot;.Htm&amp;quot;&lt;/span&gt;,&lt;span class=&#34;string&#34;&gt;&amp;quot;.pHtml&amp;quot;&lt;/span&gt;,&lt;span class=&#34;string&#34;&gt;&amp;quot;.jsp&amp;quot;&lt;/span&gt;,&lt;span class=&#34;string&#34;&gt;&amp;quot;.jspa&amp;quot;&lt;/span&gt;,&lt;span class=&#34;string&#34;&gt;&amp;quot;.jspx&amp;quot;&lt;/span&gt;,&lt;span class=&#34;string&#34;&gt;&amp;quot;.jsw&amp;quot;&lt;/span&gt;,&lt;span class=&#34;string&#34;&gt;&amp;quot;.jsv&amp;quot;&lt;/span&gt;,&lt;span class=&#34;string&#34;&gt;&amp;quot;.jspf&amp;quot;&lt;/span&gt;,&lt;span class=&#34;string&#34;&gt;&amp;quot;.jtml&amp;quot;&lt;/span&gt;,&lt;span class=&#34;string&#34;&gt;&amp;quot;.jSp&amp;quot;&lt;/span&gt;,&lt;span class=&#34;string&#34;&gt;&amp;quot;.jSpx&amp;quot;&lt;/span&gt;,&lt;span class=&#34;string&#34;&gt;&amp;quot;.jSpa&amp;quot;&lt;/span&gt;,&lt;span class=&#34;string&#34;&gt;&amp;quot;.jSw&amp;quot;&lt;/span&gt;,&lt;span class=&#34;string&#34;&gt;&amp;quot;.jSv&amp;quot;&lt;/span&gt;,&lt;span class=&#34;string&#34;&gt;&amp;quot;.jSpf&amp;quot;&lt;/span&gt;,&lt;span class=&#34;string&#34;&gt;&amp;quot;.jHtml&amp;quot;&lt;/span&gt;,&lt;span class=&#34;string&#34;&gt;&amp;quot;.asp&amp;quot;&lt;/span&gt;,&lt;span class=&#34;string&#34;&gt;&amp;quot;.aspx&amp;quot;&lt;/span&gt;,&lt;span class=&#34;string&#34;&gt;&amp;quot;.asa&amp;quot;&lt;/span&gt;,&lt;span class=&#34;string&#34;&gt;&amp;quot;.asax&amp;quot;&lt;/span&gt;,&lt;span class=&#34;string&#34;&gt;&amp;quot;.ascx&amp;quot;&lt;/span&gt;,&lt;span class=&#34;string&#34;&gt;&amp;quot;.ashx&amp;quot;&lt;/span&gt;,&lt;span class=&#34;string&#34;&gt;&amp;quot;.asmx&amp;quot;&lt;/span&gt;,&lt;span class=&#34;string&#34;&gt;&amp;quot;.cer&amp;quot;&lt;/span&gt;,&lt;span class=&#34;string&#34;&gt;&amp;quot;.aSp&amp;quot;&lt;/span&gt;,&lt;span class=&#34;string&#34;&gt;&amp;quot;.aSpx&amp;quot;&lt;/span&gt;,&lt;span class=&#34;string&#34;&gt;&amp;quot;.aSa&amp;quot;&lt;/span&gt;,&lt;span class=&#34;string&#34;&gt;&amp;quot;.aSax&amp;quot;&lt;/span&gt;,&lt;span class=&#34;string&#34;&gt;&amp;quot;.aScx&amp;quot;&lt;/span&gt;,&lt;span class=&#34;string&#34;&gt;&amp;quot;.aShx&amp;quot;&lt;/span&gt;,&lt;span class=&#34;string&#34;&gt;&amp;quot;.aSmx&amp;quot;&lt;/span&gt;,&lt;span class=&#34;string&#34;&gt;&amp;quot;.cEr&amp;quot;&lt;/span&gt;,&lt;span class=&#34;string&#34;&gt;&amp;quot;.sWf&amp;quot;&lt;/span&gt;,&lt;span class=&#34;string&#34;&gt;&amp;quot;.swf&amp;quot;&lt;/span&gt;,&lt;span class=&#34;string&#34;&gt;&amp;quot;.htaccess&amp;quot;&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &lt;span class=&#34;variable&#34;&gt;$file_name&lt;/span&gt; = &lt;span class=&#34;title function_ invoke__&#34;&gt;trim&lt;/span&gt;(&lt;span class=&#34;variable&#34;&gt;$_FILES&lt;/span&gt;[&lt;span class=&#34;string&#34;&gt;&amp;#x27;upload_file&amp;#x27;&lt;/span&gt;][&lt;span class=&#34;string&#34;&gt;&amp;#x27;name&amp;#x27;&lt;/span&gt;]);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &lt;span class=&#34;variable&#34;&gt;$file_name&lt;/span&gt; = &lt;span class=&#34;title function_ invoke__&#34;&gt;deldot&lt;/span&gt;(&lt;span class=&#34;variable&#34;&gt;$file_name&lt;/span&gt;);&lt;span class=&#34;comment&#34;&gt;//删除文件名末尾的点&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &lt;span class=&#34;variable&#34;&gt;$file_ext&lt;/span&gt; = &lt;span class=&#34;title function_ invoke__&#34;&gt;strrchr&lt;/span&gt;(&lt;span class=&#34;variable&#34;&gt;$file_name&lt;/span&gt;, &lt;span class=&#34;string&#34;&gt;&amp;#x27;.&amp;#x27;&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &lt;span class=&#34;variable&#34;&gt;$file_ext&lt;/span&gt; = &lt;span class=&#34;title function_ invoke__&#34;&gt;strtolower&lt;/span&gt;(&lt;span class=&#34;variable&#34;&gt;$file_ext&lt;/span&gt;); &lt;span class=&#34;comment&#34;&gt;//转换为小写&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &lt;span class=&#34;variable&#34;&gt;$file_ext&lt;/span&gt; = &lt;span class=&#34;title function_ invoke__&#34;&gt;str_ireplace&lt;/span&gt;(&lt;span class=&#34;string&#34;&gt;&amp;#x27;::$DATA&amp;#x27;&lt;/span&gt;, &lt;span class=&#34;string&#34;&gt;&amp;#x27;&amp;#x27;&lt;/span&gt;, &lt;span class=&#34;variable&#34;&gt;$file_ext&lt;/span&gt;);&lt;span class=&#34;comment&#34;&gt;//去除字符串::$DATA&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &lt;span class=&#34;variable&#34;&gt;$file_ext&lt;/span&gt; = &lt;span class=&#34;title function_ invoke__&#34;&gt;trim&lt;/span&gt;(&lt;span class=&#34;variable&#34;&gt;$file_ext&lt;/span&gt;); &lt;span class=&#34;comment&#34;&gt;//首尾去空&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &lt;span class=&#34;keyword&#34;&gt;if&lt;/span&gt; (!&lt;span class=&#34;title function_ invoke__&#34;&gt;in_array&lt;/span&gt;(&lt;span class=&#34;variable&#34;&gt;$file_ext&lt;/span&gt;, &lt;span class=&#34;variable&#34;&gt;$deny_ext&lt;/span&gt;)) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;            &lt;span class=&#34;variable&#34;&gt;$temp_file&lt;/span&gt; = &lt;span class=&#34;variable&#34;&gt;$_FILES&lt;/span&gt;[&lt;span class=&#34;string&#34;&gt;&amp;#x27;upload_file&amp;#x27;&lt;/span&gt;][&lt;span class=&#34;string&#34;&gt;&amp;#x27;tmp_name&amp;#x27;&lt;/span&gt;];&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;            &lt;span class=&#34;variable&#34;&gt;$img_path&lt;/span&gt; = UPLOAD_PATH.&lt;span class=&#34;string&#34;&gt;&amp;#x27;/&amp;#x27;&lt;/span&gt;.&lt;span class=&#34;variable&#34;&gt;$file_name&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;            &lt;span class=&#34;keyword&#34;&gt;if&lt;/span&gt; (&lt;span class=&#34;title function_ invoke__&#34;&gt;move_uploaded_file&lt;/span&gt;(&lt;span class=&#34;variable&#34;&gt;$temp_file&lt;/span&gt;, &lt;span class=&#34;variable&#34;&gt;$img_path&lt;/span&gt;)) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;                &lt;span class=&#34;variable&#34;&gt;$is_upload&lt;/span&gt; = &lt;span class=&#34;literal&#34;&gt;true&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;            &amp;#125; &lt;span class=&#34;keyword&#34;&gt;else&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;                &lt;span class=&#34;variable&#34;&gt;$msg&lt;/span&gt; = &lt;span class=&#34;string&#34;&gt;&amp;#x27;上传出错！&amp;#x27;&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;            &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &amp;#125; &lt;span class=&#34;keyword&#34;&gt;else&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;            &lt;span class=&#34;variable&#34;&gt;$msg&lt;/span&gt; = &lt;span class=&#34;string&#34;&gt;&amp;#x27;此文件类型不允许上传！&amp;#x27;&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &amp;#125; &lt;span class=&#34;keyword&#34;&gt;else&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &lt;span class=&#34;variable&#34;&gt;$msg&lt;/span&gt; = UPLOAD_PATH . &lt;span class=&#34;string&#34;&gt;&amp;#x27;文件夹不存在,请手工创建！&amp;#x27;&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;其中过滤了很多，但是如果当后缀名为 &lt;code&gt;. .&lt;/code&gt;  时，文件名末尾的点只去除了一次，首尾去空以后还剩下一个点&lt;/p&gt;
&lt;p&gt;由于此时已经走完了代码的过滤流程，则可以实现上传 php 文件获得 webshell&lt;/p&gt;
&lt;p&gt;抓包，修改&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;filename=&amp;quot;backdoor.php. .&amp;quot;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;&lt;img src=&#34;image-20221003175926184.png&#34; alt=&#34;image-20221003175926184&#34;&gt;&lt;/p&gt;
&lt;p&gt;即可上传成功。&lt;/p&gt;
&lt;h2 id=&#34;后缀双写绕过&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#后缀双写绕过&#34;&gt;#&lt;/a&gt; 后缀双写绕过&lt;/h2&gt;
&lt;p&gt;查看源码:&lt;/p&gt;
&lt;figure class=&#34;highlight php&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;variable&#34;&gt;$is_upload&lt;/span&gt; = &lt;span class=&#34;literal&#34;&gt;false&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;variable&#34;&gt;$msg&lt;/span&gt; = &lt;span class=&#34;literal&#34;&gt;null&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;keyword&#34;&gt;if&lt;/span&gt; (&lt;span class=&#34;keyword&#34;&gt;isset&lt;/span&gt;(&lt;span class=&#34;variable&#34;&gt;$_POST&lt;/span&gt;[&lt;span class=&#34;string&#34;&gt;&amp;#x27;submit&amp;#x27;&lt;/span&gt;])) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;keyword&#34;&gt;if&lt;/span&gt; (&lt;span class=&#34;title function_ invoke__&#34;&gt;file_exists&lt;/span&gt;(UPLOAD_PATH)) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &lt;span class=&#34;variable&#34;&gt;$deny_ext&lt;/span&gt; = &lt;span class=&#34;keyword&#34;&gt;array&lt;/span&gt;(&lt;span class=&#34;string&#34;&gt;&amp;quot;php&amp;quot;&lt;/span&gt;,&lt;span class=&#34;string&#34;&gt;&amp;quot;php5&amp;quot;&lt;/span&gt;,&lt;span class=&#34;string&#34;&gt;&amp;quot;php4&amp;quot;&lt;/span&gt;,&lt;span class=&#34;string&#34;&gt;&amp;quot;php3&amp;quot;&lt;/span&gt;,&lt;span class=&#34;string&#34;&gt;&amp;quot;php2&amp;quot;&lt;/span&gt;,&lt;span class=&#34;string&#34;&gt;&amp;quot;html&amp;quot;&lt;/span&gt;,&lt;span class=&#34;string&#34;&gt;&amp;quot;htm&amp;quot;&lt;/span&gt;,&lt;span class=&#34;string&#34;&gt;&amp;quot;phtml&amp;quot;&lt;/span&gt;,&lt;span class=&#34;string&#34;&gt;&amp;quot;pht&amp;quot;&lt;/span&gt;,&lt;span class=&#34;string&#34;&gt;&amp;quot;jsp&amp;quot;&lt;/span&gt;,&lt;span class=&#34;string&#34;&gt;&amp;quot;jspa&amp;quot;&lt;/span&gt;,&lt;span class=&#34;string&#34;&gt;&amp;quot;jspx&amp;quot;&lt;/span&gt;,&lt;span class=&#34;string&#34;&gt;&amp;quot;jsw&amp;quot;&lt;/span&gt;,&lt;span class=&#34;string&#34;&gt;&amp;quot;jsv&amp;quot;&lt;/span&gt;,&lt;span class=&#34;string&#34;&gt;&amp;quot;jspf&amp;quot;&lt;/span&gt;,&lt;span class=&#34;string&#34;&gt;&amp;quot;jtml&amp;quot;&lt;/span&gt;,&lt;span class=&#34;string&#34;&gt;&amp;quot;asp&amp;quot;&lt;/span&gt;,&lt;span class=&#34;string&#34;&gt;&amp;quot;aspx&amp;quot;&lt;/span&gt;,&lt;span class=&#34;string&#34;&gt;&amp;quot;asa&amp;quot;&lt;/span&gt;,&lt;span class=&#34;string&#34;&gt;&amp;quot;asax&amp;quot;&lt;/span&gt;,&lt;span class=&#34;string&#34;&gt;&amp;quot;ascx&amp;quot;&lt;/span&gt;,&lt;span class=&#34;string&#34;&gt;&amp;quot;ashx&amp;quot;&lt;/span&gt;,&lt;span class=&#34;string&#34;&gt;&amp;quot;asmx&amp;quot;&lt;/span&gt;,&lt;span class=&#34;string&#34;&gt;&amp;quot;cer&amp;quot;&lt;/span&gt;,&lt;span class=&#34;string&#34;&gt;&amp;quot;swf&amp;quot;&lt;/span&gt;,&lt;span class=&#34;string&#34;&gt;&amp;quot;htaccess&amp;quot;&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &lt;span class=&#34;variable&#34;&gt;$file_name&lt;/span&gt; = &lt;span class=&#34;title function_ invoke__&#34;&gt;trim&lt;/span&gt;(&lt;span class=&#34;variable&#34;&gt;$_FILES&lt;/span&gt;[&lt;span class=&#34;string&#34;&gt;&amp;#x27;upload_file&amp;#x27;&lt;/span&gt;][&lt;span class=&#34;string&#34;&gt;&amp;#x27;name&amp;#x27;&lt;/span&gt;]);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &lt;span class=&#34;variable&#34;&gt;$file_name&lt;/span&gt; = &lt;span class=&#34;title function_ invoke__&#34;&gt;str_ireplace&lt;/span&gt;(&lt;span class=&#34;variable&#34;&gt;$deny_ext&lt;/span&gt;,&lt;span class=&#34;string&#34;&gt;&amp;quot;&amp;quot;&lt;/span&gt;, &lt;span class=&#34;variable&#34;&gt;$file_name&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &lt;span class=&#34;variable&#34;&gt;$temp_file&lt;/span&gt; = &lt;span class=&#34;variable&#34;&gt;$_FILES&lt;/span&gt;[&lt;span class=&#34;string&#34;&gt;&amp;#x27;upload_file&amp;#x27;&lt;/span&gt;][&lt;span class=&#34;string&#34;&gt;&amp;#x27;tmp_name&amp;#x27;&lt;/span&gt;];&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &lt;span class=&#34;variable&#34;&gt;$img_path&lt;/span&gt; = UPLOAD_PATH.&lt;span class=&#34;string&#34;&gt;&amp;#x27;/&amp;#x27;&lt;/span&gt;.&lt;span class=&#34;variable&#34;&gt;$file_name&lt;/span&gt;;        &lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &lt;span class=&#34;keyword&#34;&gt;if&lt;/span&gt; (&lt;span class=&#34;title function_ invoke__&#34;&gt;move_uploaded_file&lt;/span&gt;(&lt;span class=&#34;variable&#34;&gt;$temp_file&lt;/span&gt;, &lt;span class=&#34;variable&#34;&gt;$img_path&lt;/span&gt;)) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;            &lt;span class=&#34;variable&#34;&gt;$is_upload&lt;/span&gt; = &lt;span class=&#34;literal&#34;&gt;true&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &amp;#125; &lt;span class=&#34;keyword&#34;&gt;else&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;            &lt;span class=&#34;variable&#34;&gt;$msg&lt;/span&gt; = &lt;span class=&#34;string&#34;&gt;&amp;#x27;上传出错！&amp;#x27;&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &amp;#125; &lt;span class=&#34;keyword&#34;&gt;else&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &lt;span class=&#34;variable&#34;&gt;$msg&lt;/span&gt; = UPLOAD_PATH . &lt;span class=&#34;string&#34;&gt;&amp;#x27;文件夹不存在,请手工创建！&amp;#x27;&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;发现核心语句是：&lt;/p&gt;
&lt;figure class=&#34;highlight php&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;variable&#34;&gt;$file_name&lt;/span&gt; = &lt;span class=&#34;title function_ invoke__&#34;&gt;str_ireplace&lt;/span&gt;(&lt;span class=&#34;variable&#34;&gt;$deny_ext&lt;/span&gt;,&lt;span class=&#34;string&#34;&gt;&amp;quot;&amp;quot;&lt;/span&gt;, &lt;span class=&#34;variable&#34;&gt;$file_name&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;它是将&lt;span class=&#34;katex&#34;&gt;&lt;span class=&#34;katex-mathml&#34;&gt;&lt;math xmlns=&#34;http://www.w3.org/1998/Math/MathML&#34;&gt;&lt;semantics&gt;&lt;mrow&gt;&lt;mi&gt;f&lt;/mi&gt;&lt;mi&gt;i&lt;/mi&gt;&lt;mi&gt;l&lt;/mi&gt;&lt;msub&gt;&lt;mi&gt;e&lt;/mi&gt;&lt;mi&gt;n&lt;/mi&gt;&lt;/msub&gt;&lt;mi&gt;a&lt;/mi&gt;&lt;mi&gt;m&lt;/mi&gt;&lt;mi&gt;e&lt;/mi&gt;&lt;mtext&gt;变量中获取到的文件上传名，从中遍历&lt;/mtext&gt;&lt;/mrow&gt;&lt;annotation encoding=&#34;application/x-tex&#34;&gt;file_name变量中获取到的文件上传名，从中遍历&lt;/annotation&gt;&lt;/semantics&gt;&lt;/math&gt;&lt;/span&gt;&lt;span class=&#34;katex-html&#34; aria-hidden=&#34;true&#34;&gt;&lt;span class=&#34;base&#34;&gt;&lt;span class=&#34;strut&#34; style=&#34;height:0.8888799999999999em;vertical-align:-0.19444em;&#34;&gt;&lt;/span&gt;&lt;span class=&#34;mord mathnormal&#34; style=&#34;margin-right:0.10764em;&#34;&gt;f&lt;/span&gt;&lt;span class=&#34;mord mathnormal&#34;&gt;i&lt;/span&gt;&lt;span class=&#34;mord mathnormal&#34; style=&#34;margin-right:0.01968em;&#34;&gt;l&lt;/span&gt;&lt;span class=&#34;mord&#34;&gt;&lt;span class=&#34;mord mathnormal&#34;&gt;e&lt;/span&gt;&lt;span class=&#34;msupsub&#34;&gt;&lt;span class=&#34;vlist-t vlist-t2&#34;&gt;&lt;span class=&#34;vlist-r&#34;&gt;&lt;span class=&#34;vlist&#34; style=&#34;height:0.151392em;&#34;&gt;&lt;span style=&#34;top:-2.5500000000000003em;margin-left:0em;margin-right:0.05em;&#34;&gt;&lt;span class=&#34;pstrut&#34; style=&#34;height:2.7em;&#34;&gt;&lt;/span&gt;&lt;span class=&#34;sizing reset-size6 size3 mtight&#34;&gt;&lt;span class=&#34;mord mathnormal mtight&#34;&gt;n&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;vlist-s&#34;&gt;​&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;vlist-r&#34;&gt;&lt;span class=&#34;vlist&#34; style=&#34;height:0.15em;&#34;&gt;&lt;span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;span class=&#34;mord mathnormal&#34;&gt;a&lt;/span&gt;&lt;span class=&#34;mord mathnormal&#34;&gt;m&lt;/span&gt;&lt;span class=&#34;mord mathnormal&#34;&gt;e&lt;/span&gt;&lt;span class=&#34;mord cjk_fallback&#34;&gt;变&lt;/span&gt;&lt;span class=&#34;mord cjk_fallback&#34;&gt;量&lt;/span&gt;&lt;span class=&#34;mord cjk_fallback&#34;&gt;中&lt;/span&gt;&lt;span class=&#34;mord cjk_fallback&#34;&gt;获&lt;/span&gt;&lt;span class=&#34;mord cjk_fallback&#34;&gt;取&lt;/span&gt;&lt;span class=&#34;mord cjk_fallback&#34;&gt;到&lt;/span&gt;&lt;span class=&#34;mord cjk_fallback&#34;&gt;的&lt;/span&gt;&lt;span class=&#34;mord cjk_fallback&#34;&gt;文&lt;/span&gt;&lt;span class=&#34;mord cjk_fallback&#34;&gt;件&lt;/span&gt;&lt;span class=&#34;mord cjk_fallback&#34;&gt;上&lt;/span&gt;&lt;span class=&#34;mord cjk_fallback&#34;&gt;传&lt;/span&gt;&lt;span class=&#34;mord cjk_fallback&#34;&gt;名&lt;/span&gt;&lt;span class=&#34;mord cjk_fallback&#34;&gt;，&lt;/span&gt;&lt;span class=&#34;mord cjk_fallback&#34;&gt;从&lt;/span&gt;&lt;span class=&#34;mord cjk_fallback&#34;&gt;中&lt;/span&gt;&lt;span class=&#34;mord cjk_fallback&#34;&gt;遍&lt;/span&gt;&lt;span class=&#34;mord cjk_fallback&#34;&gt;历&lt;/span&gt;&lt;/span&gt;&lt;/span&gt;&lt;/span&gt; deny_ext 数组的内容，如果发现有相同字符串，则替换成空&lt;/p&gt;
&lt;p&gt;如下测试：&lt;/p&gt;
&lt;figure class=&#34;highlight php&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;filename=&lt;span class=&#34;string&#34;&gt;&amp;quot;backdoor.phphpp&amp;quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;&lt;img src=&#34;image-20221003180734935.png&#34; alt=&#34;image-20221003180734935&#34;&gt;&lt;/p&gt;
&lt;p&gt;那么改变下双写位置就可以有：&lt;/p&gt;
&lt;figure class=&#34;highlight php&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;filename=&lt;span class=&#34;string&#34;&gt;&amp;quot;backdoor.pphphp&amp;quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;&lt;img src=&#34;image-20221003181058551.png&#34; alt=&#34;image-20221003181058551&#34;&gt;&lt;/p&gt;
&lt;p&gt;上传成功。&lt;/p&gt;
</content>
        <category term="文件上传漏洞探究" />
        <updated>2022-10-03T09:24:28.000Z</updated>
    </entry>
    <entry>
        <id>https://kiyomijin.github.io/2022/10/03/%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%BC%8F%E6%B4%9E%E6%8E%A2%E7%A9%B6/%E5%90%8E%E7%BC%80%E5%A4%A7%E5%B0%8F%E5%86%99+%E7%A9%BA%E6%A0%BC%E7%BB%95%E8%BF%87/</id>
        <title>后缀大小写+空格绕过</title>
        <link rel="alternate" href="https://kiyomijin.github.io/2022/10/03/%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%BC%8F%E6%B4%9E%E6%8E%A2%E7%A9%B6/%E5%90%8E%E7%BC%80%E5%A4%A7%E5%B0%8F%E5%86%99+%E7%A9%BA%E6%A0%BC%E7%BB%95%E8%BF%87/"/>
        <content type="html">&lt;h1 id=&#34;后缀大小写空格绕过&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#后缀大小写空格绕过&#34;&gt;#&lt;/a&gt; 后缀大小写 + 空格绕过&lt;/h1&gt;
&lt;p&gt;本次讲解后缀校验相关的简单绕过方式，大小写 + 空格绕过&lt;/p&gt;
&lt;p&gt;以 Less-05 为例：&lt;/p&gt;
&lt;h2 id=&#34;后缀大小写绕过&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#后缀大小写绕过&#34;&gt;#&lt;/a&gt; 后缀大小写绕过&lt;/h2&gt;
&lt;p&gt;常规看后台源码&lt;/p&gt;
&lt;figure class=&#34;highlight php&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;variable&#34;&gt;$is_upload&lt;/span&gt; = &lt;span class=&#34;literal&#34;&gt;false&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;variable&#34;&gt;$msg&lt;/span&gt; = &lt;span class=&#34;literal&#34;&gt;null&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;keyword&#34;&gt;if&lt;/span&gt; (&lt;span class=&#34;keyword&#34;&gt;isset&lt;/span&gt;(&lt;span class=&#34;variable&#34;&gt;$_POST&lt;/span&gt;[&lt;span class=&#34;string&#34;&gt;&amp;#x27;submit&amp;#x27;&lt;/span&gt;])) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;keyword&#34;&gt;if&lt;/span&gt; (&lt;span class=&#34;title function_ invoke__&#34;&gt;file_exists&lt;/span&gt;(UPLOAD_PATH)) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &lt;span class=&#34;variable&#34;&gt;$deny_ext&lt;/span&gt; = &lt;span class=&#34;keyword&#34;&gt;array&lt;/span&gt;(&lt;span class=&#34;string&#34;&gt;&amp;quot;.php&amp;quot;&lt;/span&gt;,&lt;span class=&#34;string&#34;&gt;&amp;quot;.php5&amp;quot;&lt;/span&gt;,&lt;span class=&#34;string&#34;&gt;&amp;quot;.php4&amp;quot;&lt;/span&gt;,&lt;span class=&#34;string&#34;&gt;&amp;quot;.php3&amp;quot;&lt;/span&gt;,&lt;span class=&#34;string&#34;&gt;&amp;quot;.php2&amp;quot;&lt;/span&gt;,&lt;span class=&#34;string&#34;&gt;&amp;quot;.html&amp;quot;&lt;/span&gt;,&lt;span class=&#34;string&#34;&gt;&amp;quot;.htm&amp;quot;&lt;/span&gt;,&lt;span class=&#34;string&#34;&gt;&amp;quot;.phtml&amp;quot;&lt;/span&gt;,&lt;span class=&#34;string&#34;&gt;&amp;quot;.pht&amp;quot;&lt;/span&gt;,&lt;span class=&#34;string&#34;&gt;&amp;quot;.pHp&amp;quot;&lt;/span&gt;,&lt;span class=&#34;string&#34;&gt;&amp;quot;.pHp5&amp;quot;&lt;/span&gt;,&lt;span class=&#34;string&#34;&gt;&amp;quot;.pHp4&amp;quot;&lt;/span&gt;,&lt;span class=&#34;string&#34;&gt;&amp;quot;.pHp3&amp;quot;&lt;/span&gt;,&lt;span class=&#34;string&#34;&gt;&amp;quot;.pHp2&amp;quot;&lt;/span&gt;,&lt;span class=&#34;string&#34;&gt;&amp;quot;.Html&amp;quot;&lt;/span&gt;,&lt;span class=&#34;string&#34;&gt;&amp;quot;.Htm&amp;quot;&lt;/span&gt;,&lt;span class=&#34;string&#34;&gt;&amp;quot;.pHtml&amp;quot;&lt;/span&gt;,&lt;span class=&#34;string&#34;&gt;&amp;quot;.jsp&amp;quot;&lt;/span&gt;,&lt;span class=&#34;string&#34;&gt;&amp;quot;.jspa&amp;quot;&lt;/span&gt;,&lt;span class=&#34;string&#34;&gt;&amp;quot;.jspx&amp;quot;&lt;/span&gt;,&lt;span class=&#34;string&#34;&gt;&amp;quot;.jsw&amp;quot;&lt;/span&gt;,&lt;span class=&#34;string&#34;&gt;&amp;quot;.jsv&amp;quot;&lt;/span&gt;,&lt;span class=&#34;string&#34;&gt;&amp;quot;.jspf&amp;quot;&lt;/span&gt;,&lt;span class=&#34;string&#34;&gt;&amp;quot;.jtml&amp;quot;&lt;/span&gt;,&lt;span class=&#34;string&#34;&gt;&amp;quot;.jSp&amp;quot;&lt;/span&gt;,&lt;span class=&#34;string&#34;&gt;&amp;quot;.jSpx&amp;quot;&lt;/span&gt;,&lt;span class=&#34;string&#34;&gt;&amp;quot;.jSpa&amp;quot;&lt;/span&gt;,&lt;span class=&#34;string&#34;&gt;&amp;quot;.jSw&amp;quot;&lt;/span&gt;,&lt;span class=&#34;string&#34;&gt;&amp;quot;.jSv&amp;quot;&lt;/span&gt;,&lt;span class=&#34;string&#34;&gt;&amp;quot;.jSpf&amp;quot;&lt;/span&gt;,&lt;span class=&#34;string&#34;&gt;&amp;quot;.jHtml&amp;quot;&lt;/span&gt;,&lt;span class=&#34;string&#34;&gt;&amp;quot;.asp&amp;quot;&lt;/span&gt;,&lt;span class=&#34;string&#34;&gt;&amp;quot;.aspx&amp;quot;&lt;/span&gt;,&lt;span class=&#34;string&#34;&gt;&amp;quot;.asa&amp;quot;&lt;/span&gt;,&lt;span class=&#34;string&#34;&gt;&amp;quot;.asax&amp;quot;&lt;/span&gt;,&lt;span class=&#34;string&#34;&gt;&amp;quot;.ascx&amp;quot;&lt;/span&gt;,&lt;span class=&#34;string&#34;&gt;&amp;quot;.ashx&amp;quot;&lt;/span&gt;,&lt;span class=&#34;string&#34;&gt;&amp;quot;.asmx&amp;quot;&lt;/span&gt;,&lt;span class=&#34;string&#34;&gt;&amp;quot;.cer&amp;quot;&lt;/span&gt;,&lt;span class=&#34;string&#34;&gt;&amp;quot;.aSp&amp;quot;&lt;/span&gt;,&lt;span class=&#34;string&#34;&gt;&amp;quot;.aSpx&amp;quot;&lt;/span&gt;,&lt;span class=&#34;string&#34;&gt;&amp;quot;.aSa&amp;quot;&lt;/span&gt;,&lt;span class=&#34;string&#34;&gt;&amp;quot;.aSax&amp;quot;&lt;/span&gt;,&lt;span class=&#34;string&#34;&gt;&amp;quot;.aScx&amp;quot;&lt;/span&gt;,&lt;span class=&#34;string&#34;&gt;&amp;quot;.aShx&amp;quot;&lt;/span&gt;,&lt;span class=&#34;string&#34;&gt;&amp;quot;.aSmx&amp;quot;&lt;/span&gt;,&lt;span class=&#34;string&#34;&gt;&amp;quot;.cEr&amp;quot;&lt;/span&gt;,&lt;span class=&#34;string&#34;&gt;&amp;quot;.sWf&amp;quot;&lt;/span&gt;,&lt;span class=&#34;string&#34;&gt;&amp;quot;.swf&amp;quot;&lt;/span&gt;,&lt;span class=&#34;string&#34;&gt;&amp;quot;.htaccess&amp;quot;&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &lt;span class=&#34;variable&#34;&gt;$file_name&lt;/span&gt; = &lt;span class=&#34;title function_ invoke__&#34;&gt;trim&lt;/span&gt;(&lt;span class=&#34;variable&#34;&gt;$_FILES&lt;/span&gt;[&lt;span class=&#34;string&#34;&gt;&amp;#x27;upload_file&amp;#x27;&lt;/span&gt;][&lt;span class=&#34;string&#34;&gt;&amp;#x27;name&amp;#x27;&lt;/span&gt;]);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &lt;span class=&#34;variable&#34;&gt;$file_name&lt;/span&gt; = &lt;span class=&#34;title function_ invoke__&#34;&gt;deldot&lt;/span&gt;(&lt;span class=&#34;variable&#34;&gt;$file_name&lt;/span&gt;);&lt;span class=&#34;comment&#34;&gt;//删除文件名末尾的点&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &lt;span class=&#34;variable&#34;&gt;$file_ext&lt;/span&gt; = &lt;span class=&#34;title function_ invoke__&#34;&gt;strrchr&lt;/span&gt;(&lt;span class=&#34;variable&#34;&gt;$file_name&lt;/span&gt;, &lt;span class=&#34;string&#34;&gt;&amp;#x27;.&amp;#x27;&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &lt;span class=&#34;variable&#34;&gt;$file_ext&lt;/span&gt; = &lt;span class=&#34;title function_ invoke__&#34;&gt;str_ireplace&lt;/span&gt;(&lt;span class=&#34;string&#34;&gt;&amp;#x27;::$DATA&amp;#x27;&lt;/span&gt;, &lt;span class=&#34;string&#34;&gt;&amp;#x27;&amp;#x27;&lt;/span&gt;, &lt;span class=&#34;variable&#34;&gt;$file_ext&lt;/span&gt;);&lt;span class=&#34;comment&#34;&gt;//去除字符串::$DATA&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &lt;span class=&#34;variable&#34;&gt;$file_ext&lt;/span&gt; = &lt;span class=&#34;title function_ invoke__&#34;&gt;trim&lt;/span&gt;(&lt;span class=&#34;variable&#34;&gt;$file_ext&lt;/span&gt;); &lt;span class=&#34;comment&#34;&gt;//首尾去空&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &lt;span class=&#34;keyword&#34;&gt;if&lt;/span&gt; (!&lt;span class=&#34;title function_ invoke__&#34;&gt;in_array&lt;/span&gt;(&lt;span class=&#34;variable&#34;&gt;$file_ext&lt;/span&gt;, &lt;span class=&#34;variable&#34;&gt;$deny_ext&lt;/span&gt;)) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;            &lt;span class=&#34;variable&#34;&gt;$temp_file&lt;/span&gt; = &lt;span class=&#34;variable&#34;&gt;$_FILES&lt;/span&gt;[&lt;span class=&#34;string&#34;&gt;&amp;#x27;upload_file&amp;#x27;&lt;/span&gt;][&lt;span class=&#34;string&#34;&gt;&amp;#x27;tmp_name&amp;#x27;&lt;/span&gt;];&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;            &lt;span class=&#34;variable&#34;&gt;$img_path&lt;/span&gt; = UPLOAD_PATH.&lt;span class=&#34;string&#34;&gt;&amp;#x27;/&amp;#x27;&lt;/span&gt;.&lt;span class=&#34;title function_ invoke__&#34;&gt;date&lt;/span&gt;(&lt;span class=&#34;string&#34;&gt;&amp;quot;YmdHis&amp;quot;&lt;/span&gt;).&lt;span class=&#34;title function_ invoke__&#34;&gt;rand&lt;/span&gt;(&lt;span class=&#34;number&#34;&gt;1000&lt;/span&gt;,&lt;span class=&#34;number&#34;&gt;9999&lt;/span&gt;).&lt;span class=&#34;variable&#34;&gt;$file_ext&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;            &lt;span class=&#34;keyword&#34;&gt;if&lt;/span&gt; (&lt;span class=&#34;title function_ invoke__&#34;&gt;move_uploaded_file&lt;/span&gt;(&lt;span class=&#34;variable&#34;&gt;$temp_file&lt;/span&gt;, &lt;span class=&#34;variable&#34;&gt;$img_path&lt;/span&gt;)) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;                &lt;span class=&#34;variable&#34;&gt;$is_upload&lt;/span&gt; = &lt;span class=&#34;literal&#34;&gt;true&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;            &amp;#125; &lt;span class=&#34;keyword&#34;&gt;else&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;                &lt;span class=&#34;variable&#34;&gt;$msg&lt;/span&gt; = &lt;span class=&#34;string&#34;&gt;&amp;#x27;上传出错！&amp;#x27;&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;            &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &amp;#125; &lt;span class=&#34;keyword&#34;&gt;else&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;            &lt;span class=&#34;variable&#34;&gt;$msg&lt;/span&gt; = &lt;span class=&#34;string&#34;&gt;&amp;#x27;此文件类型不允许上传！&amp;#x27;&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &amp;#125; &lt;span class=&#34;keyword&#34;&gt;else&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &lt;span class=&#34;variable&#34;&gt;$msg&lt;/span&gt; = UPLOAD_PATH . &lt;span class=&#34;string&#34;&gt;&amp;#x27;文件夹不存在,请手工创建！&amp;#x27;&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;可以看到这回直接过滤了 &lt;code&gt;.htaccess&lt;/code&gt;  以及 &lt;code&gt;.phtml&lt;/code&gt; ，但是比前几次缺少了后缀名全部转小写的操作，因此存在漏洞。&lt;/p&gt;
&lt;p&gt;抓包，送入 Repeater，将后缀名 php 变成 Php&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;filename=&amp;quot;backdoor.Php&amp;quot;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;成功上传&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;image-20221003170308084.png&#34; alt=&#34;image-20221003170308084&#34;&gt;&lt;/p&gt;
&lt;p&gt;连接菜刀即可。&lt;/p&gt;
&lt;p&gt;另外，比起黑名单列一大堆，不如使用 &lt;code&gt;白名单过滤&lt;/code&gt; 会更加简洁、安全。&lt;/p&gt;
&lt;h2 id=&#34;后缀加空格绕过&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#后缀加空格绕过&#34;&gt;#&lt;/a&gt; 后缀加空格绕过&lt;/h2&gt;
&lt;p&gt;这是一个 Windows 上才会有的特性，Linux 主机没有。&lt;/p&gt;
&lt;p&gt;以 Less-06 为例：&lt;/p&gt;
&lt;figure class=&#34;highlight php&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;variable&#34;&gt;$is_upload&lt;/span&gt; = &lt;span class=&#34;literal&#34;&gt;false&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;variable&#34;&gt;$msg&lt;/span&gt; = &lt;span class=&#34;literal&#34;&gt;null&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;keyword&#34;&gt;if&lt;/span&gt; (&lt;span class=&#34;keyword&#34;&gt;isset&lt;/span&gt;(&lt;span class=&#34;variable&#34;&gt;$_POST&lt;/span&gt;[&lt;span class=&#34;string&#34;&gt;&amp;#x27;submit&amp;#x27;&lt;/span&gt;])) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;keyword&#34;&gt;if&lt;/span&gt; (&lt;span class=&#34;title function_ invoke__&#34;&gt;file_exists&lt;/span&gt;(UPLOAD_PATH)) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &lt;span class=&#34;variable&#34;&gt;$deny_ext&lt;/span&gt; = &lt;span class=&#34;keyword&#34;&gt;array&lt;/span&gt;(&lt;span class=&#34;string&#34;&gt;&amp;quot;.php&amp;quot;&lt;/span&gt;,&lt;span class=&#34;string&#34;&gt;&amp;quot;.php5&amp;quot;&lt;/span&gt;,&lt;span class=&#34;string&#34;&gt;&amp;quot;.php4&amp;quot;&lt;/span&gt;,&lt;span class=&#34;string&#34;&gt;&amp;quot;.php3&amp;quot;&lt;/span&gt;,&lt;span class=&#34;string&#34;&gt;&amp;quot;.php2&amp;quot;&lt;/span&gt;,&lt;span class=&#34;string&#34;&gt;&amp;quot;.html&amp;quot;&lt;/span&gt;,&lt;span class=&#34;string&#34;&gt;&amp;quot;.htm&amp;quot;&lt;/span&gt;,&lt;span class=&#34;string&#34;&gt;&amp;quot;.phtml&amp;quot;&lt;/span&gt;,&lt;span class=&#34;string&#34;&gt;&amp;quot;.pht&amp;quot;&lt;/span&gt;,&lt;span class=&#34;string&#34;&gt;&amp;quot;.pHp&amp;quot;&lt;/span&gt;,&lt;span class=&#34;string&#34;&gt;&amp;quot;.pHp5&amp;quot;&lt;/span&gt;,&lt;span class=&#34;string&#34;&gt;&amp;quot;.pHp4&amp;quot;&lt;/span&gt;,&lt;span class=&#34;string&#34;&gt;&amp;quot;.pHp3&amp;quot;&lt;/span&gt;,&lt;span class=&#34;string&#34;&gt;&amp;quot;.pHp2&amp;quot;&lt;/span&gt;,&lt;span class=&#34;string&#34;&gt;&amp;quot;.Html&amp;quot;&lt;/span&gt;,&lt;span class=&#34;string&#34;&gt;&amp;quot;.Htm&amp;quot;&lt;/span&gt;,&lt;span class=&#34;string&#34;&gt;&amp;quot;.pHtml&amp;quot;&lt;/span&gt;,&lt;span class=&#34;string&#34;&gt;&amp;quot;.jsp&amp;quot;&lt;/span&gt;,&lt;span class=&#34;string&#34;&gt;&amp;quot;.jspa&amp;quot;&lt;/span&gt;,&lt;span class=&#34;string&#34;&gt;&amp;quot;.jspx&amp;quot;&lt;/span&gt;,&lt;span class=&#34;string&#34;&gt;&amp;quot;.jsw&amp;quot;&lt;/span&gt;,&lt;span class=&#34;string&#34;&gt;&amp;quot;.jsv&amp;quot;&lt;/span&gt;,&lt;span class=&#34;string&#34;&gt;&amp;quot;.jspf&amp;quot;&lt;/span&gt;,&lt;span class=&#34;string&#34;&gt;&amp;quot;.jtml&amp;quot;&lt;/span&gt;,&lt;span class=&#34;string&#34;&gt;&amp;quot;.jSp&amp;quot;&lt;/span&gt;,&lt;span class=&#34;string&#34;&gt;&amp;quot;.jSpx&amp;quot;&lt;/span&gt;,&lt;span class=&#34;string&#34;&gt;&amp;quot;.jSpa&amp;quot;&lt;/span&gt;,&lt;span class=&#34;string&#34;&gt;&amp;quot;.jSw&amp;quot;&lt;/span&gt;,&lt;span class=&#34;string&#34;&gt;&amp;quot;.jSv&amp;quot;&lt;/span&gt;,&lt;span class=&#34;string&#34;&gt;&amp;quot;.jSpf&amp;quot;&lt;/span&gt;,&lt;span class=&#34;string&#34;&gt;&amp;quot;.jHtml&amp;quot;&lt;/span&gt;,&lt;span class=&#34;string&#34;&gt;&amp;quot;.asp&amp;quot;&lt;/span&gt;,&lt;span class=&#34;string&#34;&gt;&amp;quot;.aspx&amp;quot;&lt;/span&gt;,&lt;span class=&#34;string&#34;&gt;&amp;quot;.asa&amp;quot;&lt;/span&gt;,&lt;span class=&#34;string&#34;&gt;&amp;quot;.asax&amp;quot;&lt;/span&gt;,&lt;span class=&#34;string&#34;&gt;&amp;quot;.ascx&amp;quot;&lt;/span&gt;,&lt;span class=&#34;string&#34;&gt;&amp;quot;.ashx&amp;quot;&lt;/span&gt;,&lt;span class=&#34;string&#34;&gt;&amp;quot;.asmx&amp;quot;&lt;/span&gt;,&lt;span class=&#34;string&#34;&gt;&amp;quot;.cer&amp;quot;&lt;/span&gt;,&lt;span class=&#34;string&#34;&gt;&amp;quot;.aSp&amp;quot;&lt;/span&gt;,&lt;span class=&#34;string&#34;&gt;&amp;quot;.aSpx&amp;quot;&lt;/span&gt;,&lt;span class=&#34;string&#34;&gt;&amp;quot;.aSa&amp;quot;&lt;/span&gt;,&lt;span class=&#34;string&#34;&gt;&amp;quot;.aSax&amp;quot;&lt;/span&gt;,&lt;span class=&#34;string&#34;&gt;&amp;quot;.aScx&amp;quot;&lt;/span&gt;,&lt;span class=&#34;string&#34;&gt;&amp;quot;.aShx&amp;quot;&lt;/span&gt;,&lt;span class=&#34;string&#34;&gt;&amp;quot;.aSmx&amp;quot;&lt;/span&gt;,&lt;span class=&#34;string&#34;&gt;&amp;quot;.cEr&amp;quot;&lt;/span&gt;,&lt;span class=&#34;string&#34;&gt;&amp;quot;.sWf&amp;quot;&lt;/span&gt;,&lt;span class=&#34;string&#34;&gt;&amp;quot;.swf&amp;quot;&lt;/span&gt;,&lt;span class=&#34;string&#34;&gt;&amp;quot;.htaccess&amp;quot;&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &lt;span class=&#34;variable&#34;&gt;$file_name&lt;/span&gt; = &lt;span class=&#34;variable&#34;&gt;$_FILES&lt;/span&gt;[&lt;span class=&#34;string&#34;&gt;&amp;#x27;upload_file&amp;#x27;&lt;/span&gt;][&lt;span class=&#34;string&#34;&gt;&amp;#x27;name&amp;#x27;&lt;/span&gt;];&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &lt;span class=&#34;variable&#34;&gt;$file_name&lt;/span&gt; = &lt;span class=&#34;title function_ invoke__&#34;&gt;deldot&lt;/span&gt;(&lt;span class=&#34;variable&#34;&gt;$file_name&lt;/span&gt;);&lt;span class=&#34;comment&#34;&gt;//删除文件名末尾的点&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &lt;span class=&#34;variable&#34;&gt;$file_ext&lt;/span&gt; = &lt;span class=&#34;title function_ invoke__&#34;&gt;strrchr&lt;/span&gt;(&lt;span class=&#34;variable&#34;&gt;$file_name&lt;/span&gt;, &lt;span class=&#34;string&#34;&gt;&amp;#x27;.&amp;#x27;&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &lt;span class=&#34;variable&#34;&gt;$file_ext&lt;/span&gt; = &lt;span class=&#34;title function_ invoke__&#34;&gt;strtolower&lt;/span&gt;(&lt;span class=&#34;variable&#34;&gt;$file_ext&lt;/span&gt;); &lt;span class=&#34;comment&#34;&gt;//转换为小写&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &lt;span class=&#34;variable&#34;&gt;$file_ext&lt;/span&gt; = &lt;span class=&#34;title function_ invoke__&#34;&gt;str_ireplace&lt;/span&gt;(&lt;span class=&#34;string&#34;&gt;&amp;#x27;::$DATA&amp;#x27;&lt;/span&gt;, &lt;span class=&#34;string&#34;&gt;&amp;#x27;&amp;#x27;&lt;/span&gt;, &lt;span class=&#34;variable&#34;&gt;$file_ext&lt;/span&gt;);&lt;span class=&#34;comment&#34;&gt;//去除字符串::$DATA&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &lt;span class=&#34;keyword&#34;&gt;if&lt;/span&gt; (!&lt;span class=&#34;title function_ invoke__&#34;&gt;in_array&lt;/span&gt;(&lt;span class=&#34;variable&#34;&gt;$file_ext&lt;/span&gt;, &lt;span class=&#34;variable&#34;&gt;$deny_ext&lt;/span&gt;)) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;            &lt;span class=&#34;variable&#34;&gt;$temp_file&lt;/span&gt; = &lt;span class=&#34;variable&#34;&gt;$_FILES&lt;/span&gt;[&lt;span class=&#34;string&#34;&gt;&amp;#x27;upload_file&amp;#x27;&lt;/span&gt;][&lt;span class=&#34;string&#34;&gt;&amp;#x27;tmp_name&amp;#x27;&lt;/span&gt;];&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;            &lt;span class=&#34;variable&#34;&gt;$img_path&lt;/span&gt; = UPLOAD_PATH.&lt;span class=&#34;string&#34;&gt;&amp;#x27;/&amp;#x27;&lt;/span&gt;.&lt;span class=&#34;title function_ invoke__&#34;&gt;date&lt;/span&gt;(&lt;span class=&#34;string&#34;&gt;&amp;quot;YmdHis&amp;quot;&lt;/span&gt;).&lt;span class=&#34;title function_ invoke__&#34;&gt;rand&lt;/span&gt;(&lt;span class=&#34;number&#34;&gt;1000&lt;/span&gt;,&lt;span class=&#34;number&#34;&gt;9999&lt;/span&gt;).&lt;span class=&#34;variable&#34;&gt;$file_ext&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;            &lt;span class=&#34;keyword&#34;&gt;if&lt;/span&gt; (&lt;span class=&#34;title function_ invoke__&#34;&gt;move_uploaded_file&lt;/span&gt;(&lt;span class=&#34;variable&#34;&gt;$temp_file&lt;/span&gt;,&lt;span class=&#34;variable&#34;&gt;$img_path&lt;/span&gt;)) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;                &lt;span class=&#34;variable&#34;&gt;$is_upload&lt;/span&gt; = &lt;span class=&#34;literal&#34;&gt;true&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;            &amp;#125; &lt;span class=&#34;keyword&#34;&gt;else&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;                &lt;span class=&#34;variable&#34;&gt;$msg&lt;/span&gt; = &lt;span class=&#34;string&#34;&gt;&amp;#x27;上传出错！&amp;#x27;&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;            &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &amp;#125; &lt;span class=&#34;keyword&#34;&gt;else&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;            &lt;span class=&#34;variable&#34;&gt;$msg&lt;/span&gt; = &lt;span class=&#34;string&#34;&gt;&amp;#x27;此文件不允许上传&amp;#x27;&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &amp;#125; &lt;span class=&#34;keyword&#34;&gt;else&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &lt;span class=&#34;variable&#34;&gt;$msg&lt;/span&gt; = UPLOAD_PATH . &lt;span class=&#34;string&#34;&gt;&amp;#x27;文件夹不存在,请手工创建！&amp;#x27;&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;发现，跟前面源码的差距是加入了转换为小写，却&lt;strong&gt;忘记添加上对后缀名去空格&lt;/strong&gt;。&lt;/p&gt;
&lt;p&gt;同样，抓包修改，文件名为&lt;/p&gt;
&lt;figure class=&#34;highlight php&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;filename=&lt;span class=&#34;string&#34;&gt;&amp;quot;backdoor.php &amp;quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;上传成功&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;image-20221003171112732.png&#34; alt=&#34;image-20221003171112732&#34;&gt;&lt;/p&gt;
&lt;p&gt;连接菜刀即可。&lt;/p&gt;
&lt;p&gt;在 windows 主机上一定要对后缀名进行 &lt;code&gt;去空格&lt;/code&gt; 操作。&lt;/p&gt;
&lt;p&gt;至此，演示完毕。&lt;/p&gt;
</content>
        <category term="文件上传漏洞探究" />
        <updated>2022-10-03T08:59:03.000Z</updated>
    </entry>
    <entry>
        <id>https://kiyomijin.github.io/2022/10/03/%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%BC%8F%E6%B4%9E%E6%8E%A2%E7%A9%B6/phtml%E8%A7%A3%E6%9E%90%E5%AE%A1%E8%AE%A1+%E7%BB%95%E8%BF%87/</id>
        <title>phtml解析审计+绕过</title>
        <link rel="alternate" href="https://kiyomijin.github.io/2022/10/03/%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%BC%8F%E6%B4%9E%E6%8E%A2%E7%A9%B6/phtml%E8%A7%A3%E6%9E%90%E5%AE%A1%E8%AE%A1+%E7%BB%95%E8%BF%87/"/>
        <content type="html">&lt;h1 id=&#34;phtml解析审计绕过&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#phtml解析审计绕过&#34;&gt;#&lt;/a&gt; phtml 解析审计 + 绕过&lt;/h1&gt;
&lt;p&gt;总结一下对于以下四种文件类型，可能的绕过方式：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;code&gt;.asp&lt;/code&gt; :  &lt;code&gt;.asa&lt;/code&gt; /  &lt;code&gt;.cer&lt;/code&gt; /  &lt;code&gt;.cdx&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;&lt;code&gt;.aspx&lt;/code&gt; :  &lt;code&gt;.ashx&lt;/code&gt; /  &lt;code&gt;.asmx&lt;/code&gt; /  &lt;code&gt;.ascx&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;&lt;code&gt;.php&lt;/code&gt; :  &lt;code&gt;.php4&lt;/code&gt; /  &lt;code&gt;.php5&lt;/code&gt; /  &lt;code&gt;.pthml&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;&lt;code&gt;.jsp&lt;/code&gt; :  &lt;code&gt;.jspx&lt;/code&gt; /  &lt;code&gt;.jspf&lt;/code&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id=&#34;pthml解析审计&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#pthml解析审计&#34;&gt;#&lt;/a&gt; pthml 解析审计&lt;/h2&gt;
&lt;p&gt;其中，关于 pthml 可以去看一下 &lt;code&gt;C:\phpStudyB\Apache\conf\httpd.conf&lt;/code&gt;  文件中对于 php 文件类型的解析&lt;/p&gt;
&lt;p&gt;这里 &lt;code&gt;.pthml&lt;/code&gt;  后缀的文件可以被后台解析成 &lt;code&gt;.php&lt;/code&gt;&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;image-20221003151119447.png&#34; alt=&#34;image-20221003151119447&#34;&gt;&lt;/p&gt;
&lt;p&gt;我们以 Pass-03 为例：&lt;/p&gt;
&lt;p&gt;上传 backdoor.php，点击上传后，显示 “&lt;strong&gt;不允许上传.asp, .aspx, .php, .jsp 后缀文件！&lt;/strong&gt;”&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;image-20221003151302968.png&#34; alt=&#34;image-20221003151302968&#34;&gt;&lt;/p&gt;
&lt;p&gt;OK，我们看一下源码信息：&lt;/p&gt;
&lt;figure class=&#34;highlight php&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;variable&#34;&gt;$is_upload&lt;/span&gt; = &lt;span class=&#34;literal&#34;&gt;false&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;variable&#34;&gt;$msg&lt;/span&gt; = &lt;span class=&#34;literal&#34;&gt;null&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;keyword&#34;&gt;if&lt;/span&gt; (&lt;span class=&#34;keyword&#34;&gt;isset&lt;/span&gt;(&lt;span class=&#34;variable&#34;&gt;$_POST&lt;/span&gt;[&lt;span class=&#34;string&#34;&gt;&amp;#x27;submit&amp;#x27;&lt;/span&gt;])) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &lt;span class=&#34;keyword&#34;&gt;if&lt;/span&gt; (&lt;span class=&#34;title function_ invoke__&#34;&gt;file_exists&lt;/span&gt;(UPLOAD_PATH)) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &lt;span class=&#34;variable&#34;&gt;$deny_ext&lt;/span&gt; = &lt;span class=&#34;keyword&#34;&gt;array&lt;/span&gt;(&lt;span class=&#34;string&#34;&gt;&amp;#x27;.asp&amp;#x27;&lt;/span&gt;,&lt;span class=&#34;string&#34;&gt;&amp;#x27;.aspx&amp;#x27;&lt;/span&gt;,&lt;span class=&#34;string&#34;&gt;&amp;#x27;.php&amp;#x27;&lt;/span&gt;,&lt;span class=&#34;string&#34;&gt;&amp;#x27;.jsp&amp;#x27;&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &lt;span class=&#34;variable&#34;&gt;$file_name&lt;/span&gt; = &lt;span class=&#34;title function_ invoke__&#34;&gt;trim&lt;/span&gt;(&lt;span class=&#34;variable&#34;&gt;$_FILES&lt;/span&gt;[&lt;span class=&#34;string&#34;&gt;&amp;#x27;upload_file&amp;#x27;&lt;/span&gt;][&lt;span class=&#34;string&#34;&gt;&amp;#x27;name&amp;#x27;&lt;/span&gt;]);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &lt;span class=&#34;variable&#34;&gt;$file_name&lt;/span&gt; = &lt;span class=&#34;title function_ invoke__&#34;&gt;deldot&lt;/span&gt;(&lt;span class=&#34;variable&#34;&gt;$file_name&lt;/span&gt;);&lt;span class=&#34;comment&#34;&gt;//删除文件名末尾的点&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &lt;span class=&#34;variable&#34;&gt;$file_ext&lt;/span&gt; = &lt;span class=&#34;title function_ invoke__&#34;&gt;strrchr&lt;/span&gt;(&lt;span class=&#34;variable&#34;&gt;$file_name&lt;/span&gt;, &lt;span class=&#34;string&#34;&gt;&amp;#x27;.&amp;#x27;&lt;/span&gt;);&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &lt;span class=&#34;variable&#34;&gt;$file_ext&lt;/span&gt; = &lt;span class=&#34;title function_ invoke__&#34;&gt;strtolower&lt;/span&gt;(&lt;span class=&#34;variable&#34;&gt;$file_ext&lt;/span&gt;); &lt;span class=&#34;comment&#34;&gt;//转换为小写&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &lt;span class=&#34;variable&#34;&gt;$file_ext&lt;/span&gt; = &lt;span class=&#34;title function_ invoke__&#34;&gt;str_ireplace&lt;/span&gt;(&lt;span class=&#34;string&#34;&gt;&amp;#x27;::$DATA&amp;#x27;&lt;/span&gt;, &lt;span class=&#34;string&#34;&gt;&amp;#x27;&amp;#x27;&lt;/span&gt;, &lt;span class=&#34;variable&#34;&gt;$file_ext&lt;/span&gt;);&lt;span class=&#34;comment&#34;&gt;//去除字符串::$DATA&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &lt;span class=&#34;variable&#34;&gt;$file_ext&lt;/span&gt; = &lt;span class=&#34;title function_ invoke__&#34;&gt;trim&lt;/span&gt;(&lt;span class=&#34;variable&#34;&gt;$file_ext&lt;/span&gt;); &lt;span class=&#34;comment&#34;&gt;//收尾去空&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &lt;span class=&#34;keyword&#34;&gt;if&lt;/span&gt;(!&lt;span class=&#34;title function_ invoke__&#34;&gt;in_array&lt;/span&gt;(&lt;span class=&#34;variable&#34;&gt;$file_ext&lt;/span&gt;, &lt;span class=&#34;variable&#34;&gt;$deny_ext&lt;/span&gt;)) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;            &lt;span class=&#34;variable&#34;&gt;$temp_file&lt;/span&gt; = &lt;span class=&#34;variable&#34;&gt;$_FILES&lt;/span&gt;[&lt;span class=&#34;string&#34;&gt;&amp;#x27;upload_file&amp;#x27;&lt;/span&gt;][&lt;span class=&#34;string&#34;&gt;&amp;#x27;tmp_name&amp;#x27;&lt;/span&gt;];&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;            &lt;span class=&#34;variable&#34;&gt;$img_path&lt;/span&gt; = UPLOAD_PATH.&lt;span class=&#34;string&#34;&gt;&amp;#x27;/&amp;#x27;&lt;/span&gt;.&lt;span class=&#34;title function_ invoke__&#34;&gt;date&lt;/span&gt;(&lt;span class=&#34;string&#34;&gt;&amp;quot;YmdHis&amp;quot;&lt;/span&gt;).&lt;span class=&#34;title function_ invoke__&#34;&gt;rand&lt;/span&gt;(&lt;span class=&#34;number&#34;&gt;1000&lt;/span&gt;,&lt;span class=&#34;number&#34;&gt;9999&lt;/span&gt;).&lt;span class=&#34;variable&#34;&gt;$file_ext&lt;/span&gt;;            &lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;            &lt;span class=&#34;keyword&#34;&gt;if&lt;/span&gt; (&lt;span class=&#34;title function_ invoke__&#34;&gt;move_uploaded_file&lt;/span&gt;(&lt;span class=&#34;variable&#34;&gt;$temp_file&lt;/span&gt;,&lt;span class=&#34;variable&#34;&gt;$img_path&lt;/span&gt;)) &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;                 &lt;span class=&#34;variable&#34;&gt;$is_upload&lt;/span&gt; = &lt;span class=&#34;literal&#34;&gt;true&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;            &amp;#125; &lt;span class=&#34;keyword&#34;&gt;else&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;                &lt;span class=&#34;variable&#34;&gt;$msg&lt;/span&gt; = &lt;span class=&#34;string&#34;&gt;&amp;#x27;上传出错！&amp;#x27;&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;            &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &amp;#125; &lt;span class=&#34;keyword&#34;&gt;else&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;            &lt;span class=&#34;variable&#34;&gt;$msg&lt;/span&gt; = &lt;span class=&#34;string&#34;&gt;&amp;#x27;不允许上传.asp,.aspx,.php,.jsp后缀文件！&amp;#x27;&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &amp;#125; &lt;span class=&#34;keyword&#34;&gt;else&lt;/span&gt; &amp;#123;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;        &lt;span class=&#34;variable&#34;&gt;$msg&lt;/span&gt; = UPLOAD_PATH . &lt;span class=&#34;string&#34;&gt;&amp;#x27;文件夹不存在,请手工创建！&amp;#x27;&lt;/span&gt;;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;    &amp;#125;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&amp;#125;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;以上代码核心干了这么几件事：&lt;/p&gt;
&lt;p&gt;当文件上传路径存在时&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;设置黑名单，过滤 &lt;code&gt;.asp&lt;/code&gt; ,  &lt;code&gt;.aspx&lt;/code&gt; ,  &lt;code&gt;.php&lt;/code&gt; ,  &lt;code&gt;.jsp&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;&lt;code&gt;trim()&lt;/code&gt;  函数 &lt;code&gt;过滤&lt;/code&gt; 上传文件名的 &lt;code&gt;空格&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;&lt;code&gt;deldot()&lt;/code&gt;  函数 &lt;code&gt;删除&lt;/code&gt; 文件名 &lt;code&gt;最末尾的点&lt;/code&gt; 【这是一种绕过方式，后面的博客会介绍到】&lt;/li&gt;
&lt;li&gt;&lt;code&gt;strrchr()&lt;/code&gt;  函数以 &lt;code&gt;.点&lt;/code&gt; 为截断符，获取其右边的字符串，即获取 &lt;code&gt;文件后缀名&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;&lt;code&gt;strtolower()&lt;/code&gt;  函数将文件后缀名全部转换成 &lt;code&gt;小写&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;&lt;code&gt;str_ireplace()&lt;/code&gt;  函数将去除后缀名当中的 &lt;code&gt;::$DATA&lt;/code&gt; ，是一种 Windows 本地文件系统中的文件流，也是一种绕过方式&lt;/li&gt;
&lt;li&gt;再次调用 &lt;code&gt;trim()&lt;/code&gt;  函数对后缀名进行 &lt;code&gt;去空格&lt;/code&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;另外， &lt;code&gt;$img_path&lt;/code&gt;  这回使用了 &lt;code&gt;date函数及其格式化&lt;/code&gt; ，再使用了 &lt;code&gt;1000-9999的随机数&lt;/code&gt; 作为路径名的组成部分。&lt;/p&gt;
&lt;p&gt;date () 函数的第一个必需参数 &lt;em&gt;format&lt;/em&gt; 规定了如何格式化日期 / 时间。&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;
&lt;p&gt;可以在字母之间插入其他字符，比如 “/”、&amp;quot;.&amp;quot; 或者 “-”，这样就可以增加附加格式了&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;figure class=&#34;highlight php&#34;&gt;&lt;figcaption data-lang=&#34;PHP&#34;&gt;&lt;/figcaption&gt;&lt;table&gt;&lt;tr&gt;&lt;td data-num=&#34;1&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token php language-php&#34;&gt;&lt;span class=&#34;token delimiter important&#34;&gt;&amp;lt;?php&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;2&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token keyword&#34;&gt;echo&lt;/span&gt; &lt;span class=&#34;token function&#34;&gt;date&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;token string double-quoted-string&#34;&gt;&#34;Y/m/d&#34;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;)&lt;/span&gt; &lt;span class=&#34;token operator&#34;&gt;.&lt;/span&gt; &lt;span class=&#34;token string double-quoted-string&#34;&gt;&#34;&amp;lt;br&gt;&#34;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;3&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token keyword&#34;&gt;echo&lt;/span&gt; &lt;span class=&#34;token function&#34;&gt;date&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;token string double-quoted-string&#34;&gt;&#34;Y.m.d&#34;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;)&lt;/span&gt; &lt;span class=&#34;token operator&#34;&gt;.&lt;/span&gt; &lt;span class=&#34;token string double-quoted-string&#34;&gt;&#34;&amp;lt;br&gt;&#34;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;4&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token keyword&#34;&gt;echo&lt;/span&gt; &lt;span class=&#34;token function&#34;&gt;date&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;token string double-quoted-string&#34;&gt;&#34;Y-m-d&#34;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;)&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;5&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token delimiter important&#34;&gt;?&gt;&lt;/span&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;6&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;7&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;上面代码的输出如下所示：&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;8&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;2016/10/21&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;9&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;2016.10.21&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;10&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;2016-10-21&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;11&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token comment&#34;&gt;&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;- 这里列出了一些可用的字符：&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;  - Y - 代表年 （四位，如2022）&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;  - m - 代表月 （01 到 12）&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;  - d - 代表月中的天 （01 到 31）&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;- H - 小时，24 小时格式，有前导零 （00 到 23）&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;  - i - 有前导零的分钟数 （00 到 59）&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;- s - 秒数，有前导零 （00 到 59）&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;## pthml解析绕过&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;审计完上述代码，发现对于文件后缀并没有过滤完整，放出了诸如php4、php5、pthml的类型&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;抓包，送入Repeater&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;### 尝试一：修改为.php4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;修改为&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;```php&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;filename=&amp;quot;backdoor.php4&amp;quot;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;上传成功&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;image-20221003154317074.png&#34; alt=&#34;image-20221003154317074&#34;&gt;&lt;/p&gt;
&lt;p&gt;打开页面看看，但并没有解析成 php 执行。&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;image-20221003154519115.png&#34; alt=&#34;image-20221003154519115&#34;&gt;&lt;/p&gt;
&lt;h3 id=&#34;尝试二修改为php5&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#尝试二修改为php5&#34;&gt;#&lt;/a&gt; 尝试二：修改为.php5&lt;/h3&gt;
&lt;figure class=&#34;highlight php&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;filename=&lt;span class=&#34;string&#34;&gt;&amp;quot;backdoor.php5&amp;quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;上传成功&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;image-20221003154701928.png&#34; alt=&#34;image-20221003154701928&#34;&gt;&lt;/p&gt;
&lt;p&gt;我们打开网页看看，依旧没有解析成功&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;image-20221003154727447.png&#34; alt=&#34;image-20221003154727447&#34;&gt;&lt;/p&gt;
&lt;h3 id=&#34;尝试三修改为phtml&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#尝试三修改为phtml&#34;&gt;#&lt;/a&gt; 尝试三：修改为.phtml&lt;/h3&gt;
&lt;figure class=&#34;highlight php&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;filename=&lt;span class=&#34;string&#34;&gt;&amp;quot;backdoor.phtml&amp;quot;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;上传成功&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;image-20221003154847390.png&#34; alt=&#34;image-20221003154847390&#34;&gt;&lt;/p&gt;
&lt;p&gt;打开网页看看，没有原样输出，成功解析。&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;image-20221003154915997.png&#34; alt=&#34;image-20221003154915997&#34;&gt;&lt;/p&gt;
&lt;p&gt;使用菜刀连接：&lt;/p&gt;
&lt;p&gt;①清空缓存库&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;image-20221003155031987.png&#34; alt=&#34;image-20221003155031987&#34;&gt;&lt;/p&gt;
&lt;p&gt;②添加，输入刚刚上传的后门 url，添加参数&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;image-20221003155130387.png&#34; alt=&#34;image-20221003155130387&#34;&gt;&lt;/p&gt;
&lt;p&gt;双击，成功连接。&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;image-20221003155153049.png&#34; alt=&#34;image-20221003155153049&#34;&gt;&lt;/p&gt;
&lt;p&gt;另外，由于解析源码中只罗列了 &lt;code&gt;.php&lt;/code&gt; ,  &lt;code&gt;.phtml&lt;/code&gt; ，我们可以添加 &lt;code&gt;.txt &lt;/code&gt; 或者  &lt;code&gt;.abcd&lt;/code&gt;  都可以。&lt;/p&gt;
&lt;p&gt;只要写入了支持解析的类型，重启 Apache 服务，黑客就可以上传对应的后门文件，进行菜刀连接。&lt;/p&gt;
&lt;p&gt;至此，演示完毕。&lt;/p&gt;
</content>
        <category term="文件上传漏洞探究" />
        <updated>2022-10-03T07:05:25.000Z</updated>
    </entry>
    <entry>
        <id>https://kiyomijin.github.io/2022/10/03/%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%BC%8F%E6%B4%9E%E6%8E%A2%E7%A9%B6/Content-type%E9%AA%8C%E8%AF%81%E5%AE%A1%E8%AE%A1+%E7%BB%95%E8%BF%87/</id>
        <title>Content-type验证审计+绕过</title>
        <link rel="alternate" href="https://kiyomijin.github.io/2022/10/03/%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%BC%8F%E6%B4%9E%E6%8E%A2%E7%A9%B6/Content-type%E9%AA%8C%E8%AF%81%E5%AE%A1%E8%AE%A1+%E7%BB%95%E8%BF%87/"/>
        <content type="html">&lt;h1 id=&#34;content-type验证审计绕过&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#content-type验证审计绕过&#34;&gt;#&lt;/a&gt; content-type 验证审计 + 绕过&lt;/h1&gt;
&lt;p&gt;本篇讲解对于文件上传漏洞中 ——content type 验证审计 + 绕过&lt;/p&gt;
&lt;h2 id=&#34;content-type验证审计&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#content-type验证审计&#34;&gt;#&lt;/a&gt; content-type 验证审计&lt;/h2&gt;
&lt;p&gt;来到 Pass-02&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;image-20221003135212262.png&#34; alt=&#34;image-20221003135212262&#34;&gt;&lt;/p&gt;
&lt;p&gt;我们点击上传，会提示 “文件类型不正确，请重新上传”&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;image-20221003135246520.png&#34; alt=&#34;image-20221003135246520&#34;&gt;&lt;/p&gt;
&lt;p&gt;不多说，直接开始抓包，看看怎么个情况。&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;image-20221003135340470.png&#34; alt=&#34;image-20221003135340470&#34;&gt;&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;媒体类型&lt;/strong&gt;（通常称为 &lt;strong&gt;Multipurpose Internet Mail Extensions&lt;/strong&gt; 或 &lt;strong&gt;MIME&lt;/strong&gt; 类型）是一种标准，用来表示文档、文件或字节流的性质和格式。&lt;/p&gt;
&lt;p&gt;通用结构：&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;type/subtype&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;MIME 的组成结构非常简单；由类型与子类型两个字符串中间用 &lt;code&gt;&#39;/&#39;&lt;/code&gt;  分隔而组成。不允许空格存在。&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;code&gt;type&lt;/code&gt;  表示可以被分多个子类的独立类别。&lt;/li&gt;
&lt;li&gt;&lt;code&gt;subtype&lt;/code&gt;  表示细分后的每个类型&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;独立类型如下&lt;/p&gt;
&lt;figure class=&#34;highlight plaintext&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;text/plain&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;text/html&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;image/jpeg&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;image/png&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;audio/mpeg&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;audio/ogg&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;audio/*&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;video/mp4&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;application/*&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;application/json&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;application/javascript&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;application/ecmascript&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;application/octet-stream&lt;/span&gt;&lt;br&gt;&lt;span class=&#34;line&#34;&gt;…&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;&lt;img src=&#34;image-20221003135647652.png&#34; alt=&#34;image-20221003135647652&#34;&gt;&lt;/p&gt;
&lt;p&gt;上传文件的时候，Content-Type 有两类标识：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;标识文件上传的请求 multipart/form-data【可用于 &lt;code&gt;HTML表单&lt;/code&gt; 从浏览器发送信息给服务器】&lt;/li&gt;
&lt;li&gt;标识文件类型 application/octet-stream 【这是应用程序文件的默认值。意思是 &lt;code&gt;未知的应用程序文件&lt;/code&gt; ，浏览器一般不会自动执行或询问执行】&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;了解了基本上传格式后，查看源码内容【单击 “显示源码” 按钮】&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;image-20221003140629128.png&#34; alt=&#34;image-20221003140629128&#34;&gt;&lt;/p&gt;
&lt;p&gt;这一段的主要逻辑：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;
&lt;p&gt;定义 &lt;code&gt;$is_upload&lt;/code&gt;  变量，默认值为 false&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;定义 &lt;code&gt;$msg&lt;/code&gt;  变量，默认值为空&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;&lt;code&gt;isset&lt;/code&gt;  函数判断 &lt;code&gt;submit的POST请求&lt;/code&gt; 是否为空&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;如果为空，什么都不做&lt;/li&gt;
&lt;li&gt;如果不为空，则继续往下走&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;判断 &lt;code&gt;UPLOAD_PATH&lt;/code&gt;  上传目录是否存在&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;如果不存在，则返回 “文件夹不存在，请手工创建”&lt;/li&gt;
&lt;li&gt;如果存在，则继续往下走&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;判断 &lt;code&gt;upload_file&lt;/code&gt;  的 type 的字段的值是否为 image/jpeg 、png、gif 中的任意一个&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;如果不是，则返回 &amp;quot;文件类型不正确，请重新上传&amp;quot;&lt;/li&gt;
&lt;li&gt;如果是，则继续往下走&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;定义一个 &lt;code&gt;$temp_file&lt;/code&gt;  变量，接收 &lt;code&gt;upload_file&lt;/code&gt;  的 &lt;code&gt;tmp_name&lt;/code&gt;  字段的值&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;
&lt;p&gt;&lt;code&gt;$ _FILES [&#39;upload_file&#39;]&lt;/code&gt;  表示内置名为 &lt;code&gt;upload_file&lt;/code&gt;  的 &lt;code&gt;FILES数组&lt;/code&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;figure class=&#34;highlight php&#34;&gt;&lt;figcaption data-lang=&#34;PHP&#34;&gt;&lt;/figcaption&gt;&lt;table&gt;&lt;tr&gt;&lt;td data-num=&#34;1&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token class-name type-declaration&#34;&gt;PHP&lt;/span&gt; &lt;span class=&#34;token variable&#34;&gt;$_FILES&lt;/span&gt; 是一个预定义的数组，用来获取通过 &lt;span class=&#34;token constant&#34;&gt;POST&lt;/span&gt; 方法上传文件的相关信息。&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;2&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;如果为单个文件上传，那么 &lt;span class=&#34;token variable&#34;&gt;$_FILES&lt;/span&gt; 为二维数组；&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;3&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;如果为多个文件上传，那么 &lt;span class=&#34;token variable&#34;&gt;$_FILES&lt;/span&gt; 为三维数组。&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;4&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token variable&#34;&gt;$_FILES&lt;/span&gt;数组内容如下&lt;span class=&#34;token punctuation&#34;&gt;:&lt;/span&gt; &lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;5&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token variable&#34;&gt;$_FILES&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;token string single-quoted-string&#34;&gt;&#39;upload_file&#39;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;token string single-quoted-string&#34;&gt;&#39;name&#39;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt; 客户端文件的原名称。 &lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;6&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token variable&#34;&gt;$_FILES&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;token string single-quoted-string&#34;&gt;&#39;upload_file&#39;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;token string single-quoted-string&#34;&gt;&#39;type&#39;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt; 文件的 &lt;span class=&#34;token constant&#34;&gt;MIME&lt;/span&gt; 类型，需要浏览器提供该信息的支持，例如&lt;span class=&#34;token string double-quoted-string&#34;&gt;&#34;image/gif&#34;&lt;/span&gt;。 &lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;7&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token variable&#34;&gt;$_FILES&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;token string single-quoted-string&#34;&gt;&#39;upload_file&#39;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;token string single-quoted-string&#34;&gt;&#39;size&#39;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt; 已上传文件的大小，单位为字节。 &lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;8&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token variable&#34;&gt;$_FILES&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;token string single-quoted-string&#34;&gt;&#39;upload_file&#39;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;token string single-quoted-string&#34;&gt;&#39;tmp_name&#39;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt; 文件被上传后在服务端储存的临时文件名，一般是系统默认。可以在php&lt;span class=&#34;token operator&#34;&gt;.&lt;/span&gt;ini的upload_tmp_dir 指定，但用&lt;span class=&#34;token function&#34;&gt;putenv&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;(&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;)&lt;/span&gt; 函数设置是不起作用的。 &lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;tr&gt;&lt;td data-num=&#34;9&#34;&gt;&lt;/td&gt;&lt;td&gt;&lt;pre&gt;&lt;span class=&#34;token variable&#34;&gt;$_FILES&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;token string single-quoted-string&#34;&gt;&#39;upload_file&#39;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;token string single-quoted-string&#34;&gt;&#39;error&#39;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt; 和该文件上传相关的错误代码。&lt;span class=&#34;token punctuation&#34;&gt;[&lt;/span&gt;&lt;span class=&#34;token string single-quoted-string&#34;&gt;&#39;error&#39;&lt;/span&gt;&lt;span class=&#34;token punctuation&#34;&gt;]&lt;/span&gt; 是在 &lt;span class=&#34;token constant&#34;&gt;PHP&lt;/span&gt; &lt;span class=&#34;token number&#34;&gt;4.2&lt;/span&gt;&lt;span class=&#34;token number&#34;&gt;.0&lt;/span&gt; 版本中增加的。下面是它的说明：&lt;span class=&#34;token punctuation&#34;&gt;(&lt;/span&gt;它们在&lt;span class=&#34;token constant&#34;&gt;PHP3&lt;/span&gt;&lt;span class=&#34;token number&#34;&gt;.0&lt;/span&gt;以后成了常量&lt;span class=&#34;token punctuation&#34;&gt;)&lt;/span&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;定义一个 img_path 变量，接收 UPLOAD_PATH+’/’+upload_file 关联信息中 name 字段的值&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;code&gt;[&#39;name&#39;]&lt;/code&gt;  是表示 &lt;code&gt;文件&amp;quot;在上传者机器上&amp;quot;的文件名&lt;/code&gt;  ，或者叫 &lt;code&gt;客户端文件的原名称&lt;/code&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;判断 &lt;code&gt;move_uploaded_file&lt;/code&gt;  的返回值，其函数原型为 &lt;code&gt;move_uploaded_file( string file, string dest)&lt;/code&gt; ，意为 &lt;code&gt;将上传的file移动到dest&lt;/code&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;如果临时文件 &lt;code&gt;$temp_file&lt;/code&gt;  成功移动到 &lt;code&gt;$img_path&lt;/code&gt;  当中【&lt;strong&gt;相当于 linux 的 mv 指令&lt;/strong&gt;】，那么就令 &lt;code&gt;$is_upload&lt;/code&gt;  为 &lt;code&gt;true&lt;/code&gt; ，并返回 &amp;quot;上传 Success！&amp;quot;&lt;/li&gt;
&lt;li&gt;如果没有移动成功，则返回 “上传出错！”&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id=&#34;content-type绕过&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#content-type绕过&#34;&gt;#&lt;/a&gt; content-type 绕过&lt;/h2&gt;
&lt;p&gt;抓包后将 &lt;code&gt;Content-type字段的值&lt;/code&gt; 修改为 &lt;code&gt;image/jpeg&lt;/code&gt; 、 &lt;code&gt;image/png&lt;/code&gt; 、 &lt;code&gt;image/gif&lt;/code&gt;  的任何一种即可实现绕过。&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;image-20221003144019576.png&#34; alt=&#34;image-20221003144019576&#34;&gt;&lt;/p&gt;
&lt;p&gt;修改如下&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;image-20221003144200588.png&#34; alt=&#34;image-20221003144200588&#34;&gt;&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;点击 Forward，提示 &amp;quot;上传 Success！&amp;quot;&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;image-20221003144223909.png&#34; alt=&#34;image-20221003144223909&#34;&gt;&lt;/p&gt;
&lt;p&gt;至此，content-type 验证审计 + 绕过演示完毕。&lt;/p&gt;
</content>
        <category term="文件上传漏洞探究" />
        <updated>2022-10-03T06:44:03.000Z</updated>
    </entry>
    <entry>
        <id>https://kiyomijin.github.io/2022/10/03/%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%BC%8F%E6%B4%9E%E6%8E%A2%E7%A9%B6/%E5%89%8D%E5%8F%B0JS%E9%AA%8C%E8%AF%81%E5%AE%A1%E8%AE%A1+%E7%BB%95%E8%BF%87/</id>
        <title>前台JS验证审计+绕过</title>
        <link rel="alternate" href="https://kiyomijin.github.io/2022/10/03/%E6%96%87%E4%BB%B6%E4%B8%8A%E4%BC%A0%E6%BC%8F%E6%B4%9E%E6%8E%A2%E7%A9%B6/%E5%89%8D%E5%8F%B0JS%E9%AA%8C%E8%AF%81%E5%AE%A1%E8%AE%A1+%E7%BB%95%E8%BF%87/"/>
        <content type="html">&lt;h1 id=&#34;文件上传漏洞&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#文件上传漏洞&#34;&gt;#&lt;/a&gt; 文件上传漏洞&lt;/h1&gt;
&lt;p&gt;在讲前台 JS 绕过之前，由于是文件上传漏洞探究系列的第一讲，先来简单介绍一下文件上传漏洞。&lt;/p&gt;
&lt;h2 id=&#34;文件上传漏洞的原因&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#文件上传漏洞的原因&#34;&gt;#&lt;/a&gt; 文件上传漏洞的原因&lt;/h2&gt;
&lt;ul&gt;
&lt;li&gt;对于上传文件的后缀名 (扩展名) 没有做较为严格的限制&lt;/li&gt;
&lt;li&gt;对于上传文件的 MIMETYPE (content-type，用于描述文件类型的一种描述方法)，没有做检查&lt;/li&gt;
&lt;li&gt;权限上没有对于上传的文件目录设置不可执行权限&lt;/li&gt;
&lt;li&gt;web server 对于上传文件或者指定目录的行为没有做限制。&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;​	在 Web 中进行文件上传的原理是通过将表单设置为 &lt;code&gt;multipart/form-data&lt;/code&gt; ，同时加入文件域，而后通过 HTTP 协议将文件内容发送到服务器，服务器端读取这个分段（&lt;strong&gt;multipart&lt;/strong&gt;）的数据信息，并将其中的文件内容提取出来并保存。&lt;/p&gt;
&lt;p&gt;​	通常，在进行文件保存的时候，服务器端会读取文件的原始文件名，并从这个原始文件名中得出文件的扩展名，而后随机为文件起一个文件名（为了防止重复），并且加上原始文件的扩展名来保存到服务器上。&lt;/p&gt;
&lt;h2 id=&#34;文件上传漏洞的危害&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#文件上传漏洞的危害&#34;&gt;#&lt;/a&gt; 文件上传漏洞的危害&lt;/h2&gt;
&lt;ul&gt;
&lt;li&gt;上传 web 木马文件、控制 web 服务器文件、远程命令执行等&lt;/li&gt;
&lt;li&gt;上传系统病毒、木马文件进行挖矿、僵尸网络&lt;/li&gt;
&lt;li&gt;上传系统溢出程序进行权限提升&lt;/li&gt;
&lt;li&gt;修改 web 页面实现钓鱼、挂马、暗链等操作&lt;/li&gt;
&lt;li&gt;内网渗透&lt;/li&gt;
&lt;li&gt;在权限得到提升的情况下，想做什么就做什么&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id=&#34;文件上传合法性检测方法&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#文件上传合法性检测方法&#34;&gt;#&lt;/a&gt; 文件上传合法性检测方法&lt;/h2&gt;
&lt;ul&gt;
&lt;li&gt;前端 Js 验证&lt;/li&gt;
&lt;li&gt;MIME 类型验证&lt;/li&gt;
&lt;li&gt;黑名单 / 白名单&lt;/li&gt;
&lt;li&gt;检查文件内容 (getimagesize () 函数用于获取图像信息、校验关键字)&lt;/li&gt;
&lt;li&gt;禁止本地文件包含漏洞&lt;/li&gt;
&lt;li&gt;使用安全的 web 服务 (Apache、nginx (/test.png/xxx.php)、IIS 解析漏洞 (1.php;jpg))&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id=&#34;文件上传漏洞8种常见绕过方法&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#文件上传漏洞8种常见绕过方法&#34;&gt;#&lt;/a&gt; 文件上传漏洞 8 种常见绕过方法&lt;/h2&gt;
&lt;p&gt;（整体会有 20 多种，这里列举常见 8 种）&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;前端 Js 绕过&lt;/li&gt;
&lt;li&gt;MIME 类型绕过&lt;/li&gt;
&lt;li&gt;后缀名大小写绕过 /php4、php5&lt;/li&gt;
&lt;li&gt;00 截断&lt;/li&gt;
&lt;li&gt;覆盖.htaccess&lt;/li&gt;
&lt;li&gt;Windows 文件流特性绕过&lt;/li&gt;
&lt;li&gt;双写文件名绕过&lt;/li&gt;
&lt;li&gt;条件竞争&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id=&#34;文件下载漏洞概念&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#文件下载漏洞概念&#34;&gt;#&lt;/a&gt; 文件下载漏洞概念&lt;/h2&gt;
&lt;ul&gt;
&lt;li&gt;一些网站由于业务需求，往往需要提供文件查看或文件下载功能，但若对用户查看或下载的文件不做限制，则恶意用户就能够查看或下载任意敏感文件，这就是文件查看与下载漏洞。&lt;/li&gt;
&lt;li&gt;下载服务器任意文件，如脚本代码、服务及系统配置文件等可用得到的代码进一步做代码审计，得到更多可利用漏洞。&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id=&#34;如何查找任意文件下载漏洞呢&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#如何查找任意文件下载漏洞呢&#34;&gt;#&lt;/a&gt; 如何查找任意文件下载漏洞呢？&lt;/h2&gt;
&lt;p&gt;查找传入文件名的参数：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;导入文件等参数，要是直接输入文件名，就有可能有注入点。&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;注意如下几个参数名：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;RealPath, FilePath, filepath, Path, path, inputFile, url, urls, Lang, dis, data, readfile, filep&lt;/li&gt;
&lt;li&gt;src, menu, META-INF, WEB-INF&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;代码中如何查找漏洞：&lt;/p&gt;
&lt;p&gt;PHP 为例，有如下代码，就有可能存在任意文件下载漏洞&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;readfile&lt;/li&gt;
&lt;li&gt;fopen&lt;/li&gt;
&lt;li&gt;file_get_contents&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id=&#34;windows敏感文件路径&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#windows敏感文件路径&#34;&gt;#&lt;/a&gt; Windows 敏感文件路径&lt;/h2&gt;
&lt;p&gt;&lt;img src=&#34;image-20221003011837881.png&#34; alt=&#34;image-20221003011837881&#34;&gt;&lt;/p&gt;
&lt;h2 id=&#34;linux敏感文件路径&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#linux敏感文件路径&#34;&gt;#&lt;/a&gt; Linux 敏感文件路径&lt;/h2&gt;
&lt;p&gt;&lt;img src=&#34;image-20221003011901170.png&#34; alt=&#34;image-20221003011901170&#34;&gt;&lt;/p&gt;
&lt;h2 id=&#34;修复文件下载漏洞&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#修复文件下载漏洞&#34;&gt;#&lt;/a&gt; 修复文件下载漏洞&lt;/h2&gt;
&lt;p&gt;PHP 为例：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;过滤.(点)，使用户在 url 种不能回溯上级目录&lt;/li&gt;
&lt;li&gt;正则严格判断用户输入参数的格式&lt;/li&gt;
&lt;li&gt;php.ini 配置 open_basedir 限定文件访问范围&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;OK，进入主题&lt;/p&gt;
&lt;h1 id=&#34;配置虚拟主机&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#配置虚拟主机&#34;&gt;#&lt;/a&gt; 配置虚拟主机&lt;/h1&gt;
&lt;p&gt;虚拟主机，能够将我们的多个 apache 做成域名的方式访问。&lt;/p&gt;
&lt;p&gt;打开 phpStudyB\Apache\conf\httpd.conf 文件，一共修改两处：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;取消 LoadModule 关于 vhost_alias 的注释&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;&lt;img src=&#34;image-20221003113249079.png&#34; alt=&#34;image-20221003113249079&#34;&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;取消 Virtual hosts 的 Include 所在行注释&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;&lt;img src=&#34;image-20221003113333330.png&#34; alt=&#34;image-20221003113333330&#34;&gt;&lt;/p&gt;
&lt;p&gt;再打开 C:\phpStudyB\Apache\conf\extra\httpd-vhosts.conf 文件&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;image-20221003113809255.png&#34; alt=&#34;image-20221003113809255&#34;&gt;&lt;/p&gt;
&lt;p&gt;接下来就是重启 phpStudy 就行了。&lt;/p&gt;
&lt;h1 id=&#34;一句话木马&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#一句话木马&#34;&gt;#&lt;/a&gt; 一句话木马&lt;/h1&gt;
&lt;figure class=&#34;highlight php&#34;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&#34;code&#34;&gt;&lt;pre&gt;&lt;span class=&#34;line&#34;&gt;&lt;span class=&#34;meta&#34;&gt;&amp;lt;?php&lt;/span&gt; @&lt;span class=&#34;keyword&#34;&gt;eval&lt;/span&gt;(&lt;span class=&#34;variable&#34;&gt;$_POST&lt;/span&gt;[abcd]);&lt;span class=&#34;meta&#34;&gt;?&amp;gt;&lt;/span&gt;&lt;/span&gt;&lt;br&gt;&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;简而言之，就是只有一句代码的木马。@eval 就是执行一些传的参数命令，$_POST 接收我们的 POST 请求，参数的名称是 abcd。总之，就是可以 &lt;code&gt;执行&lt;/code&gt; 我们发送的带参数的命令请求。&lt;/p&gt;
&lt;p&gt;功能是实现：数据库管理、生成虚拟终端、文件管理。&lt;/p&gt;
&lt;h1 id=&#34;前台js验证审计绕过&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#前台js验证审计绕过&#34;&gt;#&lt;/a&gt; 前台 JS 验证审计 + 绕过&lt;/h1&gt;
&lt;h2 id=&#34;前台js验证审计&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#前台js验证审计&#34;&gt;#&lt;/a&gt; 前台 Js 验证审计&lt;/h2&gt;
&lt;p&gt;上传 backdoor.php (含有一句话木马)&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;image-20221003124200976.png&#34; alt=&#34;image-20221003124200976&#34;&gt;&lt;/p&gt;
&lt;p&gt;ok，我们开始抓包&lt;/p&gt;
&lt;p&gt;启动 BurpSuit，intercept on，结果再次点击上传按钮，却没有抓到任何的包&lt;/p&gt;
&lt;p&gt;我们 F12 看源码进行代码审计&lt;/p&gt;
&lt;h3 id=&#34;上传按钮代码审计&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#上传按钮代码审计&#34;&gt;#&lt;/a&gt; 上传按钮代码审计&lt;/h3&gt;
&lt;p&gt;首先我们知道，重要的上传逻辑肯定在这些字样的附近：&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;image-20221003124524219.png&#34; alt=&#34;image-20221003124524219&#34;&gt;&lt;/p&gt;
&lt;p&gt;那么我们找到 &amp;quot;&lt;strong&gt; 上传区&lt;/strong&gt; &amp;quot;、&amp;quot;&lt;strong&gt; 请选择要上传的图片&lt;/strong&gt; &amp;quot; 这个字样，就能精准定位到相关源码附近。&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;image-20221003124332517.png&#34; alt=&#34;image-20221003124332517&#34;&gt;&lt;/p&gt;
&lt;p&gt;上面一段代码的主要逻辑：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;
&lt;p&gt;属于 &lt;code&gt;form&lt;/code&gt;  数据，使用 &lt;code&gt;POST&lt;/code&gt;  请求&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;有&lt;strong&gt;两个&lt;/strong&gt;输入 &lt;code&gt;input&lt;/code&gt; ：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;
&lt;p&gt;一个是 input_file，类型是 &lt;code&gt;file&lt;/code&gt; ，命名为 upload_file，意为待上传的文件。&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;一个是 button，类型是 &lt;code&gt;submit&lt;/code&gt; ，命名为 submit，按钮名称为 “上传”&lt;/p&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;&lt;code&gt;form&lt;/code&gt;  请求在点击 submit 时&lt;strong&gt;会触发的方法&lt;/strong&gt; —— &lt;code&gt;onsubmit&lt;/code&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;return checkFile ()：属于 &lt;code&gt;JavaScript(简称Js)&lt;/code&gt;  语法，意为将会调用 &lt;code&gt;checkFile()&lt;/code&gt; ，并将其结果返回&lt;/li&gt;
&lt;li&gt;&lt;code&gt;onsubmit&lt;/code&gt;  就是在提交之前&lt;strong&gt;验证上传文件的合法性，属于前端验证&lt;/strong&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;好的，继续来看一下关键的 &lt;code&gt;checkFile()&lt;/code&gt;  函数都干了什么：&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;image-20221003125613717.png&#34; alt=&#34;image-20221003125613717&#34;&gt;&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;checkFile () 函数主要逻辑：&lt;/strong&gt;&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;
&lt;p&gt;通过 &lt;code&gt;getElementsByName()&lt;/code&gt;  函数，参数为 &lt;code&gt;upload_file&lt;/code&gt;  来获取其数组中第一个元素值 (下标从 0 开始)—— 也就是&lt;strong&gt; upload_file 对应的文件&lt;/strong&gt;。&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;如果 &lt;code&gt;upload_file对应的文件&lt;/code&gt; 为空，那么就弹出 &amp;quot;请选择要上传的文件！&amp;quot;&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;如果非空，则继续往下走&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;定义了允许上传的文件类型为 “.jpg| .png| .gif”&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;通过 lastIndexOf 函数获取 &lt;code&gt;最后一个.&lt;/code&gt;  出现的位置进行截取字符串，获得的是 &lt;code&gt;最后一个.&lt;/code&gt;  右边的字符串 ——&lt;strong&gt; 获得上传文件后缀名&lt;/strong&gt;&lt;/p&gt;
&lt;/li&gt;
&lt;li&gt;
&lt;p&gt;判断 &lt;code&gt;上传文件后缀名&lt;/code&gt; 是否在刚刚定义的类型里面&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;如果不在则弹出 “该文件不允许上传…”，并 return  &lt;code&gt;false&lt;/code&gt;&lt;/li&gt;
&lt;li&gt;否则 return  &lt;code&gt;true&lt;/code&gt;&lt;/li&gt;
&lt;/ul&gt;
&lt;/li&gt;
&lt;/ul&gt;
&lt;h2 id=&#34;前台js验证绕过&#34;&gt;&lt;a class=&#34;markdownIt-Anchor&#34; href=&#34;#前台js验证绕过&#34;&gt;#&lt;/a&gt; 前台 Js 验证绕过&lt;/h2&gt;
&lt;p&gt;我们再次刷新上传页面，使用 BurpSuit 抓到页面返回的源码信息&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;image-20221003130553004.png&#34; alt=&#34;image-20221003130553004&#34;&gt;&lt;/p&gt;
&lt;p&gt;直接找到刚刚定位的 checkFile () 函数，将其内容改成 &lt;code&gt;return true;&lt;/code&gt; ，意为&lt;strong&gt;无论什么文件，恒返回真&lt;/strong&gt;。&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;image-20221003130644011.png&#34; alt=&#34;image-20221003130644011&#34;&gt;&lt;/p&gt;
&lt;p&gt;点击 &amp;quot;Forward&amp;quot; 按钮。&lt;/p&gt;
&lt;p&gt;然后上传我们的一句话木马，backdoor.php，点击 “上传”，之后就可以成功抓到包。&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;image-20221003130804344.png&#34; alt=&#34;image-20221003130804344&#34;&gt;&lt;/p&gt;
&lt;p&gt;之后一顿 Forward，提交过去。&lt;/p&gt;
&lt;p&gt;显示了我们上传的 php，即上传成功。&lt;/p&gt;
&lt;p&gt;&lt;img src=&#34;image-20221003130947145.png&#34; alt=&#34;image-20221003130947145&#34;&gt;&lt;/p&gt;
&lt;p&gt;我们使用中国菜刀连接获取 webshell 即可。&lt;/p&gt;
</content>
        <category term="文件上传漏洞探究" />
        <updated>2022-10-02T16:34:47.000Z</updated>
    </entry>
</feed>
